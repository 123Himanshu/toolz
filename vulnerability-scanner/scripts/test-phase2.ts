/**
 * Phase 2 Comprehensive Test Script
 * Tests all database connections, APIs, and processing pipeline
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function runTest(name: string, testFn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await testFn();
    results.push({
      name,
      passed: true,
      duration: Date.now() - start,
      details
    });
    console.log(`‚úÖ ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({
      name,
      passed: false,
      duration: Date.now() - start,
      error: error.message
    });
    console.log(`‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
  }
  return response.json();
}

// ============================================================================
// DATABASE TESTS
// ============================================================================

async function testDatabaseHealth(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/db/init`);
  
  if (!data.success) {
    throw new Error('Database health check failed');
  }
  
  const { health } = data;
  
  // Core databases must be healthy
  if (!health.postgres) throw new Error('PostgreSQL not connected');
  if (!health.mongodb) throw new Error('MongoDB not connected');
  
  return {
    postgres: health.postgres,
    mongodb: health.mongodb,
    redis: health.redis,
    elasticsearch: health.elasticsearch,
    overall: health.overall
  };
}

async function testDatabaseInit(): Promise<any> {
  const response = await fetch(`${BASE_URL}/api/db/init`, { method: 'POST' });
  const data = await response.json();
  
  if (!data.success && !data.message?.includes('initialized')) {
    throw new Error(data.error || 'Database initialization failed');
  }
  
  return { initialized: true };
}

// ============================================================================
// AUTHENTICATION TESTS
// ============================================================================

async function testUserRegistration(): Promise<any> {
  const testUser = {
    email: `test-${Date.now()}@example.com`,
    password: 'TestPassword123!',
    name: 'Test User'
  };
  
  const data = await fetchJSON(`${BASE_URL}/api/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(testUser)
  });
  
  if (!data.success) {
    throw new Error(data.error || 'Registration failed');
  }
  
  return { userId: data.user?.id, email: testUser.email };
}

async function testUserLogin(): Promise<any> {
  // First register a user
  const testUser = {
    email: `login-test-${Date.now()}@example.com`,
    password: 'TestPassword123!',
    name: 'Login Test User'
  };
  
  await fetchJSON(`${BASE_URL}/api/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(testUser)
  });
  
  // Then login
  const loginData = await fetchJSON(`${BASE_URL}/api/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: testUser.email,
      password: testUser.password
    })
  });
  
  if (!loginData.success || !loginData.token) {
    throw new Error('Login failed - no token received');
  }
  
  return { hasToken: !!loginData.token, role: loginData.user?.role };
}

// ============================================================================
// PHASE 2 API TESTS
// ============================================================================

async function testStatisticsAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/statistics`);
  
  if (!data.success) {
    throw new Error('Statistics API failed');
  }
  
  const { statistics } = data;
  
  // Verify structure
  if (typeof statistics.overview?.totalVulnerabilities !== 'number') {
    throw new Error('Invalid statistics structure');
  }
  
  return {
    totalVulnerabilities: statistics.overview.totalVulnerabilities,
    totalHosts: statistics.overview.totalHosts,
    totalServices: statistics.overview.totalServices,
    totalSessions: statistics.overview.totalSessions
  };
}

async function testVulnerabilitiesAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/vulnerabilities`);
  
  if (!data.success) {
    throw new Error('Vulnerabilities API failed');
  }
  
  return {
    total: data.total,
    page: data.page,
    limit: data.limit,
    dataCount: data.data?.length || 0
  };
}

async function testVulnerabilitiesWithFilters(): Promise<any> {
  // Test with severity filter
  const criticalData = await fetchJSON(`${BASE_URL}/api/phase2/vulnerabilities?severity=critical`);
  
  // Test with pagination
  const paginatedData = await fetchJSON(`${BASE_URL}/api/phase2/vulnerabilities?page=1&limit=10`);
  
  return {
    criticalFilter: criticalData.success,
    pagination: paginatedData.success,
    limit: paginatedData.limit
  };
}

async function testHostsAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/hosts`);
  
  if (!data.success) {
    throw new Error('Hosts API failed');
  }
  
  return {
    total: data.total,
    dataCount: data.data?.length || 0,
    hasMore: data.hasMore
  };
}

async function testServicesAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/services`);
  
  if (!data.success) {
    throw new Error('Services API failed');
  }
  
  return {
    total: data.total || 0,
    dataCount: data.data?.length || data.services?.length || 0
  };
}

async function testAttackPathsAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/attack-paths`);
  
  if (!data.success) {
    throw new Error('Attack Paths API failed');
  }
  
  return {
    total: data.total,
    pathsCount: data.attackPaths?.length || 0
  };
}

async function testRemediationAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/remediation`);
  
  if (!data.success) {
    throw new Error('Remediation API failed');
  }
  
  return {
    stats: data.stats || {},
    records: data.records?.length || 0
  };
}

async function testTrendingAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/trending`);
  
  if (!data.success) {
    throw new Error('Trending API failed');
  }
  
  return {
    hasData: true,
    dataPoints: data.data?.length || 0
  };
}

async function testThreatIntelAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel`);
  
  if (!data.success) {
    throw new Error('Threat Intel API failed');
  }
  
  return {
    sources: data.sources || [],
    enrichmentCount: data.enrichments?.length || 0
  };
}

// ============================================================================
// EXPORT TESTS
// ============================================================================

async function testJSONExport(): Promise<any> {
  const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
  
  if (!response.ok) {
    throw new Error(`Export failed: ${response.status}`);
  }
  
  const contentType = response.headers.get('content-type');
  const contentDisposition = response.headers.get('content-disposition');
  
  return {
    contentType,
    hasFilename: contentDisposition?.includes('filename'),
    status: response.status
  };
}

async function testCSVExport(): Promise<any> {
  const response = await fetch(`${BASE_URL}/api/phase2/export?format=csv`);
  
  if (!response.ok) {
    throw new Error(`CSV Export failed: ${response.status}`);
  }
  
  return {
    contentType: response.headers.get('content-type'),
    status: response.status
  };
}

// ============================================================================
// PAGE TESTS
// ============================================================================

async function testMainPage(): Promise<any> {
  const response = await fetch(`${BASE_URL}/`);
  
  if (!response.ok) {
    throw new Error(`Main page failed: ${response.status}`);
  }
  
  return { status: response.status };
}

async function testAnalyticsPage(): Promise<any> {
  const response = await fetch(`${BASE_URL}/analytics`);
  
  if (!response.ok) {
    throw new Error(`Analytics page failed: ${response.status}`);
  }
  
  return { status: response.status };
}

async function testLoginPage(): Promise<any> {
  const response = await fetch(`${BASE_URL}/login`);
  
  if (!response.ok) {
    throw new Error(`Login page failed: ${response.status}`);
  }
  
  return { status: response.status };
}

async function testNewScanPage(): Promise<any> {
  const response = await fetch(`${BASE_URL}/scan/new`);
  
  if (!response.ok) {
    throw new Error(`New Scan page failed: ${response.status}`);
  }
  
  return { status: response.status };
}

// ============================================================================
// SCAN API TESTS
// ============================================================================

async function testScanListAPI(): Promise<any> {
  const data = await fetchJSON(`${BASE_URL}/api/scan`);
  
  // Should return array of scans
  if (!Array.isArray(data)) {
    throw new Error('Scan list should return array');
  }
  
  return {
    scanCount: data.length,
    hasScans: data.length > 0
  };
}

// ============================================================================
// MAIN TEST RUNNER
// ============================================================================

async function runAllTests(): Promise<void> {
  console.log('\nüß™ Phase 2 Comprehensive Test Suite\n');
  console.log('='.repeat(50));
  
  // Database Tests
  console.log('\nüì¶ Database Tests:');
  await runTest('Database Health Check', testDatabaseHealth);
  await runTest('Database Initialization', testDatabaseInit);
  
  // Authentication Tests
  console.log('\nüîê Authentication Tests:');
  await runTest('User Registration', testUserRegistration);
  await runTest('User Login', testUserLogin);
  
  // Phase 2 API Tests
  console.log('\nüìä Phase 2 API Tests:');
  await runTest('Statistics API', testStatisticsAPI);
  await runTest('Vulnerabilities API', testVulnerabilitiesAPI);
  await runTest('Vulnerabilities with Filters', testVulnerabilitiesWithFilters);
  await runTest('Hosts API', testHostsAPI);
  await runTest('Services API', testServicesAPI);
  await runTest('Attack Paths API', testAttackPathsAPI);
  await runTest('Remediation API', testRemediationAPI);
  await runTest('Trending API', testTrendingAPI);
  await runTest('Threat Intel API', testThreatIntelAPI);
  
  // Export Tests
  console.log('\nüì§ Export Tests:');
  await runTest('JSON Export', testJSONExport);
  await runTest('CSV Export', testCSVExport);
  
  // Page Tests
  console.log('\nüåê Page Tests:');
  await runTest('Main Dashboard', testMainPage);
  await runTest('Analytics Page', testAnalyticsPage);
  await runTest('Login Page', testLoginPage);
  await runTest('New Scan Page', testNewScanPage);
  
  // Scan API Tests
  console.log('\nüîç Scan API Tests:');
  await runTest('Scan List API', testScanListAPI);
  
  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('üìã Test Summary:\n');
  
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`Total Tests: ${results.length}`);
  console.log(`‚úÖ Passed: ${passed}`);
  console.log(`‚ùå Failed: ${failed}`);
  console.log(`‚è±Ô∏è  Total Time: ${totalTime}ms`);
  
  if (failed > 0) {
    console.log('\n‚ùå Failed Tests:');
    results.filter(r => !r.passed).forEach(r => {
      console.log(`  - ${r.name}: ${r.error}`);
    });
  }
  
  console.log('\n' + '='.repeat(50));
  
  // Return results as JSON for parsing
  console.log('\nüìä Detailed Results (JSON):');
  console.log(JSON.stringify({ passed, failed, total: results.length, results }, null, 2));
}

// Run tests
runAllTests().catch(console.error);
