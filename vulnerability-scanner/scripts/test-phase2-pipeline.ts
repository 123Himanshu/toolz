/**
 * Phase 2 Processing Pipeline Test
 * Tests the full vulnerability processing pipeline with mock data
 */

const BASE_URL = 'http://localhost:3000';

// Mock scan results from different tools
const mockScanResults = {
  nmap: {
    success: true,
    target: '192.168.1.100',
    hosts: [
      {
        ip: '192.168.1.100',
        hostname: 'test-server.local',
        state: 'up',
        ports: [
          { port: 22, protocol: 'tcp', state: 'open', service: 'ssh', version: 'OpenSSH 7.9' },
          { port: 80, protocol: 'tcp', state: 'open', service: 'http', version: 'Apache 2.4.41' },
          { port: 443, protocol: 'tcp', state: 'open', service: 'https', version: 'Apache 2.4.41' },
          { port: 3306, protocol: 'tcp', state: 'open', service: 'mysql', version: 'MySQL 5.7.32' }
        ]
      }
    ]
  },
  nuclei: {
    success: true,
    target: '192.168.1.100',
    vulnerabilities_found: 3,
    vulnerabilities: [
      {
        template_id: 'apache-detect',
        name: 'Apache HTTP Server Detection',
        severity: 'info',
        host: '192.168.1.100',
        port: 80,
        matched_at: 'http://192.168.1.100/',
        description: 'Apache HTTP Server was detected'
      },
      {
        template_id: 'cve-2021-41773',
        name: 'Apache HTTP Server Path Traversal (CVE-2021-41773)',
        severity: 'critical',
        host: '192.168.1.100',
        port: 80,
        matched_at: 'http://192.168.1.100/cgi-bin/.%2e/%2e%2e/%2e%2e/etc/passwd',
        description: 'A path traversal vulnerability in Apache HTTP Server 2.4.49 allows remote attackers to read arbitrary files.',
        cve: ['CVE-2021-41773'],
        cwe: ['CWE-22'],
        cvss: 7.5,
        references: ['https://nvd.nist.gov/vuln/detail/CVE-2021-41773']
      },
      {
        template_id: 'mysql-empty-password',
        name: 'MySQL Empty Root Password',
        severity: 'high',
        host: '192.168.1.100',
        port: 3306,
        matched_at: '192.168.1.100:3306',
        description: 'MySQL server allows root login without password',
        cwe: ['CWE-521']
      }
    ]
  },
  nikto: {
    success: true,
    target: 'http://192.168.1.100',
    vulnerabilities: [
      {
        id: 'OSVDB-3092',
        method: 'GET',
        uri: '/admin/',
        description: 'Admin directory found',
        severity: 'medium'
      },
      {
        id: 'OSVDB-3268',
        method: 'GET',
        uri: '/icons/',
        description: 'Directory indexing found',
        severity: 'low'
      }
    ]
  },
  trivy: {
    success: true,
    target: '192.168.1.100',
    vulnerabilities: [
      {
        VulnerabilityID: 'CVE-2021-3711',
        PkgName: 'openssl',
        InstalledVersion: '1.1.1k',
        FixedVersion: '1.1.1l',
        Severity: 'HIGH',
        Title: 'OpenSSL SM2 Decryption Buffer Overflow',
        Description: 'A buffer overflow vulnerability in OpenSSL SM2 decryption'
      }
    ]
  }
};

async function testProcessingPipeline(): Promise<void> {
  console.log('\nüî¨ Testing Phase 2 Processing Pipeline\n');
  console.log('='.repeat(50));

  // Test 1: Process mock scan results through the API
  console.log('\n1Ô∏è‚É£ Testing /api/phase2/process endpoint...');
  
  try {
    const processResponse = await fetch(`${BASE_URL}/api/phase2/process`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scanId: `test-scan-${Date.now()}`,
        target: '192.168.1.100',
        results: mockScanResults,
        tools: ['nmap', 'nuclei', 'nikto', 'trivy']
      })
    });

    const processData = await processResponse.json();
    
    if (processData.success) {
      console.log('‚úÖ Processing successful!');
      console.log(`   - Vulnerabilities: ${processData.result?.vulnerabilities || 0}`);
      console.log(`   - Hosts: ${processData.result?.hosts || 0}`);
      console.log(`   - Services: ${processData.result?.services || 0}`);
      console.log(`   - Deduplication: ${JSON.stringify(processData.result?.deduplication || {})}`);
      console.log(`   - Risk Score: ${processData.result?.riskScore?.overall || 0}`);
    } else {
      console.log('‚ùå Processing failed:', processData.error);
    }
  } catch (error: any) {
    console.log('‚ùå Processing error:', error.message);
  }

  // Test 2: Verify data was stored
  console.log('\n2Ô∏è‚É£ Verifying stored data...');
  
  try {
    const statsResponse = await fetch(`${BASE_URL}/api/phase2/statistics`);
    const statsData = await statsResponse.json();
    
    if (statsData.success) {
      console.log('‚úÖ Statistics retrieved:');
      console.log(`   - Total Vulnerabilities: ${statsData.statistics.overview.totalVulnerabilities}`);
      console.log(`   - Total Hosts: ${statsData.statistics.overview.totalHosts}`);
      console.log(`   - Total Services: ${statsData.statistics.overview.totalServices}`);
      console.log(`   - Severity Breakdown: ${JSON.stringify(statsData.statistics.severity)}`);
    }
  } catch (error: any) {
    console.log('‚ùå Stats error:', error.message);
  }

  // Test 3: Query vulnerabilities
  console.log('\n3Ô∏è‚É£ Querying vulnerabilities...');
  
  try {
    const vulnsResponse = await fetch(`${BASE_URL}/api/phase2/vulnerabilities?severity=critical,high`);
    const vulnsData = await vulnsResponse.json();
    
    if (vulnsData.success) {
      console.log('‚úÖ Critical/High vulnerabilities:');
      console.log(`   - Count: ${vulnsData.total}`);
      if (vulnsData.data?.length > 0) {
        vulnsData.data.slice(0, 3).forEach((v: any) => {
          console.log(`   - ${v.title} (${v.severity?.label || 'unknown'})`);
        });
      }
    }
  } catch (error: any) {
    console.log('‚ùå Query error:', error.message);
  }

  // Test 4: Check hosts inventory
  console.log('\n4Ô∏è‚É£ Checking hosts inventory...');
  
  try {
    const hostsResponse = await fetch(`${BASE_URL}/api/phase2/hosts`);
    const hostsData = await hostsResponse.json();
    
    if (hostsData.success) {
      console.log('‚úÖ Hosts inventory:');
      console.log(`   - Total Hosts: ${hostsData.total}`);
      if (hostsData.data?.length > 0) {
        hostsData.data.slice(0, 3).forEach((h: any) => {
          console.log(`   - ${h.ip} (${h.hostname || 'no hostname'}) - Risk: ${h.riskScore?.toFixed(1) || 0}`);
        });
      }
    }
  } catch (error: any) {
    console.log('‚ùå Hosts error:', error.message);
  }

  // Test 5: Check attack paths
  console.log('\n5Ô∏è‚É£ Checking attack paths...');
  
  try {
    const pathsResponse = await fetch(`${BASE_URL}/api/phase2/attack-paths`);
    const pathsData = await pathsResponse.json();
    
    if (pathsData.success) {
      console.log('‚úÖ Attack paths:');
      console.log(`   - Total Paths: ${pathsData.total}`);
      if (pathsData.attackPaths?.length > 0) {
        pathsData.attackPaths.slice(0, 2).forEach((p: any) => {
          console.log(`   - ${p.name} (Risk: ${p.overallRisk?.toFixed(1) || 0})`);
        });
      }
    }
  } catch (error: any) {
    console.log('‚ùå Attack paths error:', error.message);
  }

  // Test 6: Test export
  console.log('\n6Ô∏è‚É£ Testing export functionality...');
  
  try {
    const exportResponse = await fetch(`${BASE_URL}/api/phase2/export?format=json&includeHosts=true`);
    
    if (exportResponse.ok) {
      const contentType = exportResponse.headers.get('content-type');
      console.log('‚úÖ Export successful:');
      console.log(`   - Content-Type: ${contentType}`);
      console.log(`   - Status: ${exportResponse.status}`);
    }
  } catch (error: any) {
    console.log('‚ùå Export error:', error.message);
  }

  // Test 7: Test threat intel enrichment
  console.log('\n7Ô∏è‚É£ Testing threat intel enrichment...');
  
  try {
    const intelResponse = await fetch(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-41773`);
    const intelData = await intelResponse.json();
    
    if (intelData.success) {
      console.log('‚úÖ Threat intel retrieved:');
      console.log(`   - CVE: ${intelData.cve}`);
      console.log(`   - Has Intel: ${!!intelData.threatIntel}`);
    }
  } catch (error: any) {
    console.log('‚ùå Threat intel error:', error.message);
  }

  console.log('\n' + '='.repeat(50));
  console.log('üèÅ Pipeline test complete!\n');
}

testProcessingPipeline().catch(console.error);
