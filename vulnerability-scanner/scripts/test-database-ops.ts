/**
 * Database Operations Deep Test
 * Tests PostgreSQL, MongoDB, and Redis operations directly
 */

const BASE_URL = 'http://localhost:3000';

async function testDatabaseOperations(): Promise<void> {
  console.log('\nüóÑÔ∏è Database Operations Deep Test\n');
  console.log('='.repeat(50));

  // Test 1: PostgreSQL - Query vulnerabilities table
  console.log('\n1Ô∏è‚É£ PostgreSQL Tests...');
  
  try {
    // Test via statistics API which queries PostgreSQL
    const statsResponse = await fetch(`${BASE_URL}/api/phase2/statistics`);
    const statsData = await statsResponse.json();
    
    console.log('‚úÖ PostgreSQL query successful');
    console.log(`   - Vulnerabilities in DB: ${statsData.statistics?.overview?.totalVulnerabilities || 0}`);
    console.log(`   - Hosts in DB: ${statsData.statistics?.overview?.totalHosts || 0}`);
    console.log(`   - Sessions in DB: ${statsData.statistics?.overview?.totalSessions || 0}`);
  } catch (error: any) {
    console.log('‚ùå PostgreSQL test failed:', error.message);
  }

  // Test 2: MongoDB - Check raw outputs and logs
  console.log('\n2Ô∏è‚É£ MongoDB Tests...');
  
  try {
    // MongoDB is used for raw scan outputs - test via health check
    const healthResponse = await fetch(`${BASE_URL}/api/db/init`);
    const healthData = await healthResponse.json();
    
    if (healthData.health?.mongodb) {
      console.log('‚úÖ MongoDB connection healthy');
      console.log(`   - Status: Connected`);
    } else {
      console.log('‚ùå MongoDB not connected');
    }
  } catch (error: any) {
    console.log('‚ùå MongoDB test failed:', error.message);
  }

  // Test 3: Redis - Session and caching
  console.log('\n3Ô∏è‚É£ Redis Tests...');
  
  try {
    const healthResponse = await fetch(`${BASE_URL}/api/db/init`);
    const healthData = await healthResponse.json();
    
    if (healthData.health?.redis) {
      console.log('‚úÖ Redis connection healthy');
      console.log(`   - Status: Connected`);
      
      // Test session creation via login
      const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: `redis-test-${Date.now()}@example.com`,
          password: 'TestPassword123!'
        })
      });
      
      // First register
      await fetch(`${BASE_URL}/api/auth/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: `redis-test-${Date.now()}@example.com`,
          password: 'TestPassword123!',
          name: 'Redis Test'
        })
      });
      
      console.log('‚úÖ Redis session management working');
    } else {
      console.log('‚ö†Ô∏è Redis not connected (sessions will use fallback)');
    }
  } catch (error: any) {
    console.log('‚ùå Redis test failed:', error.message);
  }

  // Test 4: Data Persistence - Create and retrieve
  console.log('\n4Ô∏è‚É£ Data Persistence Tests...');
  
  try {
    // Create a test scan via processing
    const testScanId = `persistence-test-${Date.now()}`;
    
    const processResponse = await fetch(`${BASE_URL}/api/phase2/process`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scanId: testScanId,
        target: '10.0.0.1',
        results: {
          nmap: {
            success: true,
            hosts: [{
              ip: '10.0.0.1',
              hostname: 'persistence-test',
              state: 'up',
              ports: [{ port: 22, protocol: 'tcp', state: 'open', service: 'ssh' }]
            }]
          },
          nuclei: {
            success: true,
            vulnerabilities: [{
              template_id: 'test-vuln',
              name: 'Persistence Test Vulnerability',
              severity: 'medium',
              host: '10.0.0.1',
              port: 22,
              description: 'Test vulnerability for persistence check'
            }]
          }
        },
        tools: ['nmap', 'nuclei']
      })
    });
    
    const processData = await processResponse.json();
    
    if (processData.success) {
      console.log('‚úÖ Data created successfully');
      
      // Now retrieve it
      const vulnsResponse = await fetch(`${BASE_URL}/api/phase2/vulnerabilities?host=10.0.0.1`);
      const vulnsData = await vulnsResponse.json();
      
      if (vulnsData.success && vulnsData.total > 0) {
        console.log('‚úÖ Data retrieved successfully');
        console.log(`   - Found ${vulnsData.total} vulnerabilities for host 10.0.0.1`);
      } else {
        console.log('‚ö†Ô∏è Data created but not found in query');
      }
    } else {
      console.log('‚ùå Data creation failed:', processData.error);
    }
  } catch (error: any) {
    console.log('‚ùå Persistence test failed:', error.message);
  }

  // Test 5: Query Performance
  console.log('\n5Ô∏è‚É£ Query Performance Tests...');
  
  try {
    const queries = [
      { name: 'All vulnerabilities', url: '/api/phase2/vulnerabilities' },
      { name: 'Critical only', url: '/api/phase2/vulnerabilities?severity=critical' },
      { name: 'All hosts', url: '/api/phase2/hosts' },
      { name: 'Statistics', url: '/api/phase2/statistics' },
      { name: 'Attack paths', url: '/api/phase2/attack-paths' }
    ];
    
    for (const query of queries) {
      const start = Date.now();
      await fetch(`${BASE_URL}${query.url}`);
      const duration = Date.now() - start;
      
      const status = duration < 1000 ? '‚úÖ' : duration < 3000 ? '‚ö†Ô∏è' : '‚ùå';
      console.log(`${status} ${query.name}: ${duration}ms`);
    }
  } catch (error: any) {
    console.log('‚ùå Performance test failed:', error.message);
  }

  // Test 6: Export Formats
  console.log('\n6Ô∏è‚É£ Export Format Tests...');
  
  const formats = ['json', 'csv', 'html', 'sarif'];
  
  for (const format of formats) {
    try {
      const response = await fetch(`${BASE_URL}/api/phase2/export?format=${format}`);
      
      if (response.ok) {
        const contentType = response.headers.get('content-type');
        console.log(`‚úÖ ${format.toUpperCase()} export: ${contentType}`);
      } else {
        console.log(`‚ùå ${format.toUpperCase()} export failed: ${response.status}`);
      }
    } catch (error: any) {
      console.log(`‚ùå ${format.toUpperCase()} export error: ${error.message}`);
    }
  }

  // Test 7: Authentication Flow
  console.log('\n7Ô∏è‚É£ Authentication Flow Tests...');
  
  try {
    const testEmail = `auth-flow-${Date.now()}@example.com`;
    const testPassword = 'SecurePassword123!';
    
    // Register
    const registerResponse = await fetch(`${BASE_URL}/api/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: testEmail,
        password: testPassword,
        name: 'Auth Flow Test'
      })
    });
    const registerData = await registerResponse.json();
    
    if (registerData.success) {
      console.log('‚úÖ Registration successful');
      
      // Login
      const loginResponse = await fetch(`${BASE_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: testEmail,
          password: testPassword
        })
      });
      const loginData = await loginResponse.json();
      
      if (loginData.success && loginData.token) {
        console.log('‚úÖ Login successful');
        console.log(`   - Token received: ${loginData.token.substring(0, 20)}...`);
        console.log(`   - User role: ${loginData.user?.role}`);
        
        // Test /me endpoint with token
        const meResponse = await fetch(`${BASE_URL}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${loginData.token}`
          }
        });
        const meData = await meResponse.json();
        
        if (meData.success) {
          console.log('‚úÖ Token validation successful');
          console.log(`   - User: ${meData.user?.email}`);
        } else {
          console.log('‚ö†Ô∏è Token validation returned:', meData.error);
        }
      } else {
        console.log('‚ùå Login failed:', loginData.error);
      }
    } else {
      console.log('‚ùå Registration failed:', registerData.error);
    }
  } catch (error: any) {
    console.log('‚ùå Auth flow test failed:', error.message);
  }

  console.log('\n' + '='.repeat(50));
  console.log('üèÅ Database operations test complete!\n');
}

testDatabaseOperations().catch(console.error);
