/**
 * Test All New Features
 * Tests MITRE ATT&CK, ZDES, AI Analysis, and all integrations
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  âœ… ${name}`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  âŒ ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  return response.json();
}

async function runTests(): Promise<void> {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ§ª NEW FEATURES TEST SUITE');
  console.log('='.repeat(60));

  // MITRE ATT&CK Tests
  console.log('\nğŸ¯ MITRE ATT&CK:');
  await test('ATT&CK Mapping API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/mitre`);
    if (!data.success) throw new Error('Failed');
    return { techniques: data.summary?.techniquesFound, tactics: data.summary?.tacticsFound };
  });

  // ZDES Tests
  console.log('\nğŸ”’ Zero-Day Exposure Score:');
  await test('ZDES API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/zdes`);
    if (!data.success) throw new Error('Failed');
    return { hosts: data.summary?.totalHosts, avgScore: data.summary?.averageScore };
  });

  // AI Analysis Tests
  console.log('\nğŸ¤– AI Analysis:');
  await test('AI Analysis - Available Actions', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis`);
    if (!data.success) throw new Error('Failed');
    return { actions: data.availableActions?.length };
  });

  await test('AI Attack Path Prediction', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis?action=attack-paths`);
    if (!data.success) throw new Error('Failed');
    return { paths: data.attackPaths?.paths?.length };
  });

  await test('AI Remediation Plan', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis?action=remediation`);
    if (!data.success) throw new Error('Failed');
    return { actions: data.remediationPlan?.prioritizedActions?.length };
  });

  // Existing Features
  console.log('\nğŸ“Š Core Features:');
  await test('Vulnerabilities API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/vulnerabilities`);
    if (!data.success) throw new Error('Failed');
    return { total: data.total };
  });

  await test('Hosts API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/hosts`);
    if (!data.success) throw new Error('Failed');
    return { total: data.total };
  });

  await test('Attack Paths API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/attack-paths`);
    if (!data.success) throw new Error('Failed');
    return { paths: data.attackPaths?.length };
  });

  await test('Threat Intel API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`);
    if (!data.success) throw new Error('Failed');
    return { cve: data.cve };
  });

  // Compliance
  console.log('\nğŸ“‹ Compliance:');
  await test('PCI DSS', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error('Failed');
    return { score: data.report?.summary?.complianceScore };
  });

  await test('OWASP Top 10', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    if (!data.success) throw new Error('Failed');
    return { score: data.report?.summary?.complianceScore };
  });

  // Scheduler & Exclusions
  console.log('\nâ° Automation:');
  await test('Scheduled Scans', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/schedules`);
    if (!data.success) throw new Error('Failed');
    return { total: data.total };
  });

  await test('Exclusion Lists', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/exclusions`);
    if (!data.success) throw new Error('Failed');
    return { total: data.total };
  });

  // RAG Chatbot
  console.log('\nğŸ’¬ RAG Chatbot:');
  await test('Chat API', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: 'What vulnerabilities were found?' })
    });
    return { hasResponse: !!data.response };
  });

  // Export
  console.log('\nğŸ“¤ Export:');
  await test('JSON Export', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
    if (!response.ok) throw new Error('Failed');
    return { status: response.status };
  });

  await test('SARIF Export', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=sarif`);
    if (!response.ok) throw new Error('Failed');
    return { status: response.status };
  });

  // Database
  console.log('\nğŸ—„ï¸ Database:');
  await test('Database Health', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/db/init`);
    if (!data.success) throw new Error('Failed');
    return { postgres: data.connections?.postgres, mongodb: data.connections?.mongodb };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ“Š TEST SUMMARY');
  console.log('='.repeat(60));

  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);

  console.log(`\nTotal: ${results.length} | âœ… Passed: ${passed} | âŒ Failed: ${failed}`);
  console.log(`â±ï¸  Time: ${(totalTime / 1000).toFixed(1)}s | Pass Rate: ${Math.round((passed / results.length) * 100)}%`);

  if (failed > 0) {
    console.log('\nâŒ Failed:');
    results.filter(r => !r.passed).forEach(r => console.log(`  - ${r.name}: ${r.error}`));
  }

  console.log('\n' + '='.repeat(60));
  if (failed === 0) {
    console.log('ğŸ‰ ALL TESTS PASSED!');
  }
}

runTests().catch(console.error);
