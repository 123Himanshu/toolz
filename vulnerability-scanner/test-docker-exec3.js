const { spawn } = require('child_process');

console.log('Testing Docker execution with spawn (same as API route)...\n');

const isWindows = process.platform === 'win32';
const command = 'docker run --rm -i security-scanner python3 -c "from nmap_wrapper import NmapWrapper; import json; scanner = NmapWrapper(docker_mode=False); result = scanner.quick_scan(\'scanme.nmap.org\'); print(json.dumps(result, default=str))"';

console.log('Command:', command);
console.log('Platform:', process.platform);
console.log('Using shell:', isWindows ? 'powershell.exe' : '/bin/sh');
console.log('\nExecuting...\n');

const shell = isWindows ? 'powershell.exe' : '/bin/sh';
const shellArgs = isWindows ? ['-NoProfile', '-Command', command] : ['-c', command];

const proc = spawn(shell, shellArgs, {
  windowsHide: true,
  stdio: ['pipe', 'pipe', 'pipe'],
});

proc.stdin.end();

let stdout = '';
let stderr = '';

proc.stdout.on('data', (data) => {
  stdout += data.toString();
});

proc.stderr.on('data', (data) => {
  stderr += data.toString();
});

proc.on('close', (code) => {
  console.log('=== STDOUT ===');
  console.log(stdout.substring(0, 500));
  console.log('\n=== STDERR ===');
  console.log(stderr);
  console.log('\n=== EXIT CODE ===');
  console.log(code);
  console.log('\nDone!');
});
