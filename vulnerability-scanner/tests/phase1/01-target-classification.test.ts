/**
 * PHASE 1 TEST: Target Classification
 * Tests target parsing, classification, and validation
 */

const BASE_URL = 'http://localhost:3000';

interface TestCase {
  name: string;
  input: any;
  expected: {
    success: boolean;
    type?: string;
    error?: string;
  };
}

const testCases: TestCase[] = [
  // Valid IP addresses
  {
    name: 'Single IPv4 address',
    input: { targets: ['192.168.1.1'] },
    expected: { success: true, type: 'ip' }
  },
  {
    name: 'Multiple IPv4 addresses',
    input: { targets: ['192.168.1.1', '10.0.0.1', '172.16.0.1'] },
    expected: { success: true }
  },
  {
    name: 'Private IP range (10.x.x.x)',
    input: { targets: ['10.0.0.1'] },
    expected: { success: true, type: 'ip' }
  },
  {
    name: 'Private IP range (172.16.x.x)',
    input: { targets: ['172.16.0.1'] },
    expected: { success: true, type: 'ip' }
  },
  {
    name: 'Private IP range (192.168.x.x)',
    input: { targets: ['192.168.1.1'] },
    expected: { success: true, type: 'ip' }
  },
  {
    name: 'Public IP address',
    input: { targets: ['8.8.8.8'] },
    expected: { success: true, type: 'ip' }
  },
  {
    name: 'Localhost IPv4',
    input: { targets: ['127.0.0.1'] },
    expected: { success: true, type: 'ip' }
  },

  // CIDR notation
  {
    name: 'CIDR /24 network',
    input: { targets: ['192.168.1.0/24'] },
    expected: { success: true }
  },
  {
    name: 'CIDR /16 network',
    input: { targets: ['10.0.0.0/16'] },
    expected: { success: true }
  },
  {
    name: 'CIDR /32 single host',
    input: { targets: ['192.168.1.1/32'] },
    expected: { success: true }
  },

  // Domain names
  {
    name: 'Simple domain',
    input: { targets: ['example.com'] },
    expected: { success: true, type: 'domain' }
  },
  {
    name: 'Subdomain',
    input: { targets: ['www.example.com'] },
    expected: { success: true, type: 'domain' }
  },
  {
    name: 'Deep subdomain',
    input: { targets: ['api.v2.example.com'] },
    expected: { success: true, type: 'domain' }
  },
  {
    name: 'Domain with hyphen',
    input: { targets: ['my-website.com'] },
    expected: { success: true, type: 'domain' }
  },

  // URLs
  {
    name: 'HTTP URL',
    input: { targets: ['http://example.com'] },
    expected: { success: true }
  },
  {
    name: 'HTTPS URL',
    input: { targets: ['https://example.com'] },
    expected: { success: true }
  },
  {
    name: 'URL with port',
    input: { targets: ['http://example.com:8080'] },
    expected: { success: true }
  },
  {
    name: 'URL with path',
    input: { targets: ['https://example.com/api/v1'] },
    expected: { success: true }
  },

  // Mixed targets
  {
    name: 'Mixed IP and domain',
    input: { targets: ['192.168.1.1', 'example.com'] },
    expected: { success: true }
  },
  {
    name: 'Mixed all types',
    input: { targets: ['192.168.1.1', 'example.com', '10.0.0.0/24', 'https://api.test.com'] },
    expected: { success: true }
  },

  // Edge cases
  {
    name: 'Empty targets array',
    input: { targets: [] },
    expected: { success: true }
  },
  {
    name: 'Missing targets field',
    input: {},
    expected: { success: false, error: 'targets array is required' }
  },
  {
    name: 'Targets as string instead of array',
    input: { targets: '192.168.1.1' },
    expected: { success: false, error: 'targets array is required' }
  },
];

async function runTests(): Promise<void> {
  console.log('\n' + '='.repeat(70));
  console.log('ðŸ“‹ PHASE 1 TEST: Target Classification');
  console.log('='.repeat(70));

  let passed = 0;
  let failed = 0;

  for (const tc of testCases) {
    try {
      const response = await fetch(`${BASE_URL}/api/classify-targets`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tc.input)
      });

      const data = await response.json();

      // Check success/failure
      if (tc.expected.success && !data.success) {
        throw new Error(`Expected success but got error: ${data.error}`);
      }
      if (!tc.expected.success && data.success) {
        throw new Error(`Expected error but got success`);
      }

      // Check error message if expected
      if (tc.expected.error && data.error !== tc.expected.error) {
        throw new Error(`Expected error "${tc.expected.error}" but got "${data.error}"`);
      }

      // Check type if expected
      if (tc.expected.type && data.targets?.[0]?.type !== tc.expected.type) {
        throw new Error(`Expected type "${tc.expected.type}" but got "${data.targets?.[0]?.type}"`);
      }

      console.log(`  âœ… ${tc.name}`);
      passed++;
    } catch (error: any) {
      console.log(`  âŒ ${tc.name}: ${error.message}`);
      failed++;
    }
  }

  console.log('\n' + '-'.repeat(70));
  console.log(`Results: ${passed} passed, ${failed} failed out of ${testCases.length} tests`);
  console.log('='.repeat(70));

  if (failed > 0) {
    process.exit(1);
  }
}

runTests().catch(console.error);
