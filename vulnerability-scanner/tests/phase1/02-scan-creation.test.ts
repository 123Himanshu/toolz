/**
 * PHASE 1 TEST: Scan Creation & Management
 * Tests scan creation, status tracking, and tool selection
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<void>): Promise<void> {
  try {
    await fn();
    results.push({ name, passed: true });
    console.log(`  ‚úÖ ${name}`);
  } catch (error: any) {
    results.push({ name, passed: false, error: error.message });
    console.log(`  ‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  return response.json();
}

async function runTests(): Promise<void> {
  console.log('\n' + '='.repeat(70));
  console.log('üìã PHASE 1 TEST: Scan Creation & Management');
  console.log('='.repeat(70));

  let createdScanId: string | null = null;

  // ============================================================================
  // SCAN CREATION TESTS
  // ============================================================================
  console.log('\nüîß Scan Creation:');

  await test('Create passive scan', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'test-passive.example.com',
        scanType: 'passive',
        tools: { network: [], web: [], system: [] }
      })
    });
    if (!data.success && !data.scanId) throw new Error(data.error || 'No scanId returned');
    createdScanId = data.scanId;
  });

  await test('Create active scan with network tools', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: '192.168.1.100',
        scanType: 'active',
        tools: { network: ['nmap', 'naabu'], web: [], system: [] }
      })
    });
    if (!data.success && !data.scanId) throw new Error(data.error || 'Failed');
  });

  await test('Create active scan with web tools', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'https://example.com',
        scanType: 'active',
        tools: { network: [], web: ['nuclei', 'nikto'], system: [] }
      })
    });
    if (!data.success && !data.scanId) throw new Error(data.error || 'Failed');
  });

  await test('Create combined scan (both passive and active)', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'example.com',
        scanType: 'both',
        tools: { network: ['nmap'], web: ['nuclei'], system: ['trivy'] }
      })
    });
    if (!data.success && !data.scanId) throw new Error(data.error || 'Failed');
  });

  // ============================================================================
  // VALIDATION TESTS
  // ============================================================================
  console.log('\nüîç Input Validation:');

  await test('Reject scan without target', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        scanType: 'active',
        tools: { network: ['nmap'], web: [], system: [] }
      })
    });
    if (data.success) throw new Error('Should have rejected missing target');
  });

  await test('Reject scan without scanType', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'example.com',
        tools: { network: ['nmap'], web: [], system: [] }
      })
    });
    if (data.success) throw new Error('Should have rejected missing scanType');
  });

  await test('Reject scan without tools', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'example.com',
        scanType: 'active'
      })
    });
    if (data.success) throw new Error('Should have rejected missing tools');
  });

  // ============================================================================
  // SCAN STATUS TESTS
  // ============================================================================
  console.log('\nüìä Scan Status:');

  await test('Get all scans', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`);
    if (!Array.isArray(data)) throw new Error('Expected array of scans');
  });

  await test('Get specific scan by ID', async () => {
    if (!createdScanId) throw new Error('No scan ID from previous test');
    const data = await fetchJSON(`${BASE_URL}/api/scan?scanId=${createdScanId}`);
    if (!data.id) throw new Error('Scan not found');
  });

  await test('Handle non-existent scan ID', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan?scanId=non-existent-id-12345`);
    if (!data.error) throw new Error('Should return error for non-existent scan');
  });

  // ============================================================================
  // EXCLUSION INTEGRATION TESTS
  // ============================================================================
  console.log('\nüö´ Exclusion Integration:');

  await test('Reject excluded target (localhost)', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: '127.0.0.1',
        scanType: 'active',
        tools: { network: ['nmap'], web: [], system: [] }
      })
    });
    if (data.success && !data.excluded) {
      // May or may not be excluded depending on config
      console.log('    (Note: localhost may not be excluded in current config)');
    }
  });

  // ============================================================================
  // TOOL RECOMMENDATION TESTS
  // ============================================================================
  console.log('\nü§ñ AI Tool Recommendations:');

  await test('Get tool recommendations for domain', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/ai/recommend`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target: 'example.com', scanType: 'active' })
    });
    // Should return some recommendations
  });

  await test('Get tool recommendations for IP', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/ai/recommend`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target: '192.168.1.1', scanType: 'active' })
    });
  });

  // Summary
  console.log('\n' + '-'.repeat(70));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  console.log(`Results: ${passed} passed, ${failed} failed out of ${results.length} tests`);
  console.log('='.repeat(70));

  if (failed > 0) {
    process.exit(1);
  }
}

runTests().catch(console.error);
