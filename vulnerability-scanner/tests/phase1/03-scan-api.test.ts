/**
 * Phase 1 Test: Scan API
 * Tests the scan API endpoints
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  ‚úÖ ${name}`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  ‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  if (!response.ok) {
    const text = await response.text();
    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
  }
  return response.json();
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('üåê PHASE 1 TEST: Scan API');
  console.log('='.repeat(60) + '\n');

  // Test 1: Target Classification
  await test('Target Classification - IP', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/classify-targets`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targets: ['192.168.1.1'] })
    });
    if (!data.success) throw new Error('Classification failed');
    if (data.targets[0].type !== 'ip') throw new Error(`Expected 'ip', got '${data.targets[0].type}'`);
    return data.targets[0];
  });

  await test('Target Classification - Domain', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/classify-targets`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targets: ['example.com'] })
    });
    if (!data.success) throw new Error('Classification failed');
    if (data.targets[0].type !== 'domain') throw new Error(`Expected 'domain', got '${data.targets[0].type}'`);
    return data.targets[0];
  });

  await test('Target Classification - CIDR', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/classify-targets`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targets: ['10.0.0.0/24'] })
    });
    if (!data.success) throw new Error('Classification failed');
    return data.targets[0];
  });

  await test('Target Classification - URL', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/classify-targets`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targets: ['https://example.com/path'] })
    });
    if (!data.success) throw new Error('Classification failed');
    return data.targets[0];
  });

  // Test 2: Scan Creation
  await test('Create Passive Scan', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'example.com',
        scanType: 'passive',
        tools: { network: [], web: [], system: [] }
      })
    });
    if (!data.success || !data.scanId) throw new Error('Scan creation failed');
    return { scanId: data.scanId };
  });

  await test('Create Active Scan', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: 'scanme.nmap.org',
        scanType: 'active',
        tools: { network: ['nmap'], web: [], system: [] }
      })
    });
    if (!data.success || !data.scanId) throw new Error('Scan creation failed');
    return { scanId: data.scanId };
  });

  // Test 3: Scan Status
  await test('Get All Scans', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/scan`);
    if (!Array.isArray(data)) throw new Error('Expected array of scans');
    return { count: data.length };
  });

  // Test 4: Exclusion Check
  await test('Excluded Target Rejected', async () => {
    const response = await fetch(`${BASE_URL}/api/scan`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target: '127.0.0.1',
        scanType: 'active',
        tools: { network: ['nmap'], web: [], system: [] }
      })
    });
    const data = await response.json();
    if (response.status !== 400 || !data.excluded) throw new Error('Expected 400 with excluded=true');
    return { excluded: true, reason: data.reason };
  });

  // Test 5: Invalid Input Handling
  await test('Missing Target Rejected', async () => {
    try {
      await fetchJSON(`${BASE_URL}/api/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scanType: 'active', tools: {} })
      });
      throw new Error('Should have rejected');
    } catch (e: any) {
      if (!e.message.includes('400')) throw new Error('Expected 400 error');
      return { rejected: true };
    }
  });

  await test('Missing ScanType Rejected', async () => {
    try {
      await fetchJSON(`${BASE_URL}/api/scan`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target: 'example.com', tools: {} })
      });
      throw new Error('Should have rejected');
    } catch (e: any) {
      if (!e.message.includes('400')) throw new Error('Expected 400 error');
      return { rejected: true };
    }
  });

  // Test 6: AI Recommendations
  await test('AI Tool Recommendations', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/ai/recommend`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target: 'example.com', scanType: 'active' })
    });
    return { hasRecommendations: !!data };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  console.log('üìä RESULTS');
  console.log('='.repeat(60));

  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;

  console.log(`\nTotal: ${results.length} | Passed: ${passed} | Failed: ${failed}`);

  if (failed > 0) {
    console.log('\n‚ùå Failed Tests:');
    results.filter(r => !r.passed).forEach(r => {
      console.log(`  - ${r.name}: ${r.error}`);
    });
    process.exit(1);
  } else {
    console.log('\n‚úÖ All Scan API tests passed!');
  }
}

runTests().catch(console.error);
