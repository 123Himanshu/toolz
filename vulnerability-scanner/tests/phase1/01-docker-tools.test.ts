/**
 * Phase 1 Test: Docker Tools Availability
 * Tests that all security tools are available in Docker container
 */

import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);
const TIMEOUT = 30000;

interface ToolTest {
  name: string;
  command: string;
  expectedOutput: string;
}

const tools: ToolTest[] = [
  { name: 'nmap', command: 'nmap --version', expectedOutput: 'nmap' },
  { name: 'nuclei', command: 'nuclei --version', expectedOutput: 'version' },
  { name: 'nikto', command: 'nikto -Version', expectedOutput: 'nikto' },
  { name: 'masscan', command: 'masscan --version 2>&1 || echo masscan', expectedOutput: 'masscan' },
  { name: 'rustscan', command: 'rustscan --version', expectedOutput: 'rustscan' },
  { name: 'naabu', command: 'naabu -version', expectedOutput: 'version' },
  { name: 'subfinder', command: 'subfinder -version', expectedOutput: 'version' },
  { name: 'httpx', command: 'httpx -version', expectedOutput: 'version' },
  { name: 'trivy', command: 'trivy --version', expectedOutput: 'version' },
  { name: 'wapiti', command: 'wapiti --version', expectedOutput: 'wapiti' },
];

async function testTool(tool: ToolTest): Promise<{ passed: boolean; output?: string; error?: string }> {
  try {
    const { stdout, stderr } = await execAsync(
      `docker run --rm security-scanner ${tool.command}`,
      { timeout: TIMEOUT }
    );
    const output = stdout + stderr;
    const passed = output.toLowerCase().includes(tool.expectedOutput.toLowerCase());
    return { passed, output: output.substring(0, 200) };
  } catch (error: any) {
    return { passed: false, error: error.message };
  }
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('üê≥ PHASE 1 TEST: Docker Tools Availability');
  console.log('='.repeat(60) + '\n');

  let passed = 0;
  let failed = 0;

  for (const tool of tools) {
    process.stdout.write(`Testing ${tool.name}... `);
    const result = await testTool(tool);
    
    if (result.passed) {
      console.log('‚úÖ PASS');
      passed++;
    } else {
      console.log(`‚ùå FAIL: ${result.error || 'Output mismatch'}`);
      failed++;
    }
  }

  console.log('\n' + '-'.repeat(60));
  console.log(`Results: ${passed}/${tools.length} tools available`);
  console.log('-'.repeat(60));

  if (failed > 0) {
    console.log('\n‚ö†Ô∏è  Some tools are missing. Run: docker build -t security-scanner .');
    process.exit(1);
  } else {
    console.log('\n‚úÖ All Docker tools are available!');
  }
}

runTests().catch(console.error);
