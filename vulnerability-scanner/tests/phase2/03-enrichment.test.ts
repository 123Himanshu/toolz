/**
 * Phase 2 Test: Enrichment
 * Tests CVE enrichment from multiple sources and AI fallback
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  ‚úÖ ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  ‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  return response.json();
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('üî¨ PHASE 2 TEST: Enrichment');
  console.log('='.repeat(60) + '\n');

  // Test NVD API
  console.log('Testing NVD API:');
  
  await test('NVD - Known CVE (CVE-2021-44228)', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`);
    if (!data.success) throw new Error('API failed');
    // Check for threatIntel or enrichment (API may use either)
    const intel = data.threatIntel || data.enrichment;
    if (!intel?.nvdScore && !intel?.nvdDescription) throw new Error('No NVD data');
    return { 
      cvss: intel.nvdScore,
      description: intel.nvdDescription?.substring(0, 50)
    };
  });

  await test('NVD - Recent CVE (CVE-2024-0001)', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2024-0001`);
    // May not exist, but should not error
    return { success: data.success };
  });

  await test('NVD - Invalid CVE handled', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=INVALID-CVE`);
    // Should return success but with no data
    return { success: data.success };
  });

  // Test EPSS API
  console.log('\nTesting EPSS API:');
  
  await test('EPSS - Known CVE', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`);
    if (!data.success) throw new Error('API failed');
    // EPSS may or may not be available
    return { 
      hasEPSS: data.enrichment?.epss !== undefined,
      score: data.enrichment?.epss?.score
    };
  });

  // Test CISA KEV
  console.log('\nTesting CISA KEV:');
  
  await test('CISA KEV - Known Exploited CVE', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`);
    if (!data.success) throw new Error('API failed');
    return { 
      inKEV: data.enrichment?.cisaKev?.inKev || false,
      ransomware: data.enrichment?.cisaKev?.ransomwareUse
    };
  });

  // Test ExploitDB
  console.log('\nTesting ExploitDB:');
  
  await test('ExploitDB - CVE with exploit', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`);
    if (!data.success) throw new Error('API failed');
    return { 
      hasExploit: data.enrichment?.exploitDb?.hasExploit || false
    };
  });

  // Test AI Fallback
  console.log('\nTesting AI Fallback:');
  
  await test('AI Analysis - Available', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis`);
    if (!data.success) throw new Error('API failed');
    return { actions: data.availableActions?.length };
  });

  await test('AI Attack Path Prediction', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis?action=attack-paths`);
    if (!data.success) throw new Error('API failed');
    return { paths: data.attackPaths?.paths?.length || 0 };
  });

  await test('AI Remediation Plan', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/ai-analysis?action=remediation`);
    if (!data.success) throw new Error('API failed');
    return { actions: data.remediationPlan?.prioritizedActions?.length || 0 };
  });

  // Test MITRE ATT&CK Mapping
  console.log('\nTesting MITRE ATT&CK:');
  
  await test('ATT&CK Mapping', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/mitre`);
    if (!data.success) throw new Error('API failed');
    return { 
      techniques: data.summary?.techniquesFound,
      tactics: data.summary?.tacticsFound
    };
  });

  // Test ZDES
  console.log('\nTesting Zero-Day Exposure Score:');
  
  await test('ZDES Calculation', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/zdes`);
    if (!data.success) throw new Error('API failed');
    return { 
      hosts: data.summary?.totalHosts,
      avgScore: data.summary?.averageScore
    };
  });

  // Edge Cases
  console.log('\nTesting Edge Cases:');
  
  await test('No CVE - Graceful handling', async () => {
    // Vulnerability without CVE should still work
    const vulnsData = await fetchJSON(`${BASE_URL}/api/phase2/vulnerabilities`);
    const noCveVulns = (vulnsData.data || []).filter((v: any) => !v.cve || v.cve.length === 0);
    return { noCveCount: noCveVulns.length };
  });

  await test('Rate limiting handled', async () => {
    // Make multiple rapid requests
    const promises = Array(3).fill(null).map(() => 
      fetchJSON(`${BASE_URL}/api/phase2/threat-intel?cve=CVE-2021-44228`)
    );
    const results = await Promise.all(promises);
    const allSuccess = results.every(r => r.success);
    return { allSuccess };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`Results: ${passed}/${results.length} passed`);
  console.log(`Total Time: ${(totalTime / 1000).toFixed(1)}s`);

  if (failed > 0) {
    console.log('\n‚ùå Failed:');
    results.filter(r => !r.passed).forEach(r => console.log(`  - ${r.name}: ${r.error}`));
    process.exit(1);
  } else {
    console.log('\n‚úÖ All enrichment tests passed!');
  }
}

runTests().catch(console.error);
