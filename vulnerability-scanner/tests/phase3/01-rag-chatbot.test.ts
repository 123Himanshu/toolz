/**
 * Phase 3 Test: RAG Chatbot
 * Tests the AI chatbot with vulnerability context
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  âœ… ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  âŒ ${name}: ${error.message}`);
  }
}

async function chat(message: string): Promise<any> {
  const response = await fetch(`${BASE_URL}/api/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message })
  });
  return response.json();
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('ğŸ’¬ PHASE 3 TEST: RAG Chatbot');
  console.log('='.repeat(60) + '\n');

  // Basic Functionality
  console.log('Testing Basic Functionality:');
  
  await test('Chat API responds', async () => {
    const data = await chat('Hello');
    if (!data.response) throw new Error('No response');
    return { hasResponse: true };
  });

  await test('Response is non-empty', async () => {
    const data = await chat('What vulnerabilities were found?');
    if (!data.response || data.response.length < 10) throw new Error('Response too short');
    return { length: data.response.length };
  });

  // Vulnerability Queries
  console.log('\nTesting Vulnerability Queries:');
  
  await test('Query - Critical vulnerabilities', async () => {
    const data = await chat('List all critical vulnerabilities');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  await test('Query - CVE specific', async () => {
    const data = await chat('Tell me about CVE-2021-44228');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  await test('Query - Host specific', async () => {
    const data = await chat('What vulnerabilities affect 192.168.1.100?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  // Compliance Queries
  console.log('\nTesting Compliance Queries:');
  
  await test('Query - PCI DSS status', async () => {
    const data = await chat('What is our PCI DSS compliance status?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  await test('Query - OWASP Top 10', async () => {
    const data = await chat('How do we score against OWASP Top 10?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  // Remediation Queries
  console.log('\nTesting Remediation Queries:');
  
  await test('Query - Fix recommendations', async () => {
    const data = await chat('How do I fix the critical vulnerabilities?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  await test('Query - Priority actions', async () => {
    const data = await chat('What should I fix first?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  // Comparison Queries
  console.log('\nTesting Comparison Queries:');
  
  await test('Query - Trend analysis', async () => {
    const data = await chat('How has our security posture changed?');
    if (!data.response) throw new Error('No response');
    return { responseLength: data.response.length };
  });

  // Edge Cases
  console.log('\nTesting Edge Cases:');
  
  await test('Empty message handled', async () => {
    const data = await chat('');
    // Should either respond or return error gracefully
    return { handled: true };
  });

  await test('Very long message handled', async () => {
    const longMessage = 'Tell me about vulnerabilities. '.repeat(100);
    const data = await chat(longMessage);
    return { handled: true };
  });

  await test('Special characters handled', async () => {
    const data = await chat('What about <script>alert("xss")</script>?');
    if (!data.response) throw new Error('No response');
    return { handled: true };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`Results: ${passed}/${results.length} passed`);
  console.log(`Total Time: ${(totalTime / 1000).toFixed(1)}s`);

  if (failed > 0) {
    console.log('\nâŒ Failed:');
    results.filter(r => !r.passed).forEach(r => console.log(`  - ${r.name}: ${r.error}`));
    process.exit(1);
  } else {
    console.log('\nâœ… All RAG chatbot tests passed!');
  }
}

runTests().catch(console.error);
