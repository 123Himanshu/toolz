/**
 * PHASE 3 TEST: Compliance Reporting
 * Tests PCI DSS, OWASP Top 10, CIS Controls compliance
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  error?: string;
  details?: any;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  try {
    const details = await fn();
    results.push({ name, passed: true, details });
    console.log(`  ‚úÖ ${name}`);
  } catch (error: any) {
    results.push({ name, passed: false, error: error.message });
    console.log(`  ‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string, options?: RequestInit): Promise<any> {
  const response = await fetch(url, options);
  return response.json();
}

async function runTests(): Promise<void> {
  console.log('\n' + '='.repeat(70));
  console.log('üìã PHASE 3 TEST: Compliance Reporting');
  console.log('='.repeat(70));

  // ============================================================================
  // FRAMEWORK LISTING TESTS
  // ============================================================================
  console.log('\nüìö Compliance Frameworks:');

  await test('List available frameworks', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?list=true`);
    if (!data.success) throw new Error(data.error || 'Failed');
    if (!data.frameworks || data.frameworks.length === 0) {
      throw new Error('No frameworks returned');
    }
    return { count: data.frameworks.length };
  });

  await test('Frameworks have required fields', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?list=true`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    for (const fw of data.frameworks || []) {
      if (!fw.id) throw new Error('Framework missing id');
      if (!fw.name) throw new Error('Framework missing name');
      if (!fw.version) throw new Error('Framework missing version');
    }
    return { validated: true };
  });

  // ============================================================================
  // PCI DSS TESTS
  // ============================================================================
  console.log('\nüí≥ PCI DSS 4.0:');

  await test('Generate PCI DSS report', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    if (!data.report) throw new Error('No report generated');
    return { 
      score: data.report.summary?.complianceScore,
      requirements: data.report.summary?.totalRequirements
    };
  });

  await test('PCI DSS has correct requirement count', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    // PCI DSS should have multiple requirements
    const reqCount = data.report?.summary?.totalRequirements || 0;
    if (reqCount < 10) {
      throw new Error(`Expected at least 10 requirements, got ${reqCount}`);
    }
    return { requirements: reqCount };
  });

  await test('PCI DSS score is percentage', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const score = data.report?.summary?.complianceScore;
    if (score < 0 || score > 100) {
      throw new Error(`Score ${score} out of range [0,100]`);
    }
    return { score };
  });

  await test('PCI DSS requirements have status', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const validStatuses = ['pass', 'fail', 'warning', 'not_applicable'];
    for (const req of data.report?.requirements || []) {
      if (!validStatuses.includes(req.status)) {
        throw new Error(`Invalid status: ${req.status}`);
      }
    }
    return { validated: true };
  });

  // ============================================================================
  // OWASP TOP 10 TESTS
  // ============================================================================
  console.log('\nüîü OWASP Top 10 2021:');

  await test('Generate OWASP Top 10 report', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    if (!data.success) throw new Error(data.error || 'Failed');
    if (!data.report) throw new Error('No report generated');
    return { 
      score: data.report.summary?.complianceScore,
      requirements: data.report.summary?.totalRequirements
    };
  });

  await test('OWASP has exactly 10 categories', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const reqCount = data.report?.summary?.totalRequirements || 0;
    if (reqCount !== 10) {
      throw new Error(`Expected 10 categories, got ${reqCount}`);
    }
    return { categories: reqCount };
  });

  await test('OWASP categories are A01-A10', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const expectedIds = ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08', 'A09', 'A10'];
    const actualIds = (data.report?.requirements || []).map((r: any) => r.id);
    
    for (const id of expectedIds) {
      if (!actualIds.includes(id)) {
        throw new Error(`Missing OWASP category: ${id}`);
      }
    }
    return { validated: true };
  });

  // ============================================================================
  // CIS CONTROLS TESTS
  // ============================================================================
  console.log('\nüõ°Ô∏è CIS Controls v8:');

  await test('Generate CIS Controls report', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=CIS%20Controls`);
    if (!data.success) throw new Error(data.error || 'Failed');
    if (!data.report) throw new Error('No report generated');
    return { 
      score: data.report.summary?.complianceScore,
      requirements: data.report.summary?.totalRequirements
    };
  });

  await test('CIS has 18 controls', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=CIS%20Controls`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const reqCount = data.report?.summary?.totalRequirements || 0;
    if (reqCount !== 18) {
      throw new Error(`Expected 18 controls, got ${reqCount}`);
    }
    return { controls: reqCount };
  });

  // ============================================================================
  // REPORT STRUCTURE TESTS
  // ============================================================================
  console.log('\nüìä Report Structure:');

  await test('Report includes summary', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    const summary = data.report?.summary;
    if (!summary) throw new Error('Missing summary');
    if (summary.totalRequirements === undefined) throw new Error('Missing totalRequirements');
    if (summary.passed === undefined) throw new Error('Missing passed count');
    if (summary.failed === undefined) throw new Error('Missing failed count');
    if (summary.complianceScore === undefined) throw new Error('Missing complianceScore');
    
    return { validated: true };
  });

  await test('Requirements include recommendations', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error(data.error || 'Failed');
    
    // At least some failed requirements should have recommendations
    const failedReqs = (data.report?.requirements || []).filter((r: any) => r.status === 'fail');
    let hasRecommendations = false;
    
    for (const req of failedReqs) {
      if (req.recommendations && req.recommendations.length > 0) {
        hasRecommendations = true;
        break;
      }
    }
    
    return { hasRecommendations, failedCount: failedReqs.length };
  });

  // ============================================================================
  // EDGE CASES
  // ============================================================================
  console.log('\n‚ö†Ô∏è Edge Cases:');

  await test('Handle invalid framework name', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=INVALID`);
    // Should return error or empty report
    return { handled: true, hasError: !!data.error };
  });

  await test('Handle missing framework parameter', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance`);
    // Should return list or error
    return { handled: true };
  });

  // Summary
  console.log('\n' + '-'.repeat(70));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  console.log(`Results: ${passed} passed, ${failed} failed out of ${results.length} tests`);
  console.log('='.repeat(70));

  if (failed > 0) {
    process.exit(1);
  }
}

runTests().catch(console.error);
