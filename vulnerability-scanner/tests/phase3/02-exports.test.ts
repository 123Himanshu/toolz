/**
 * Phase 3 Test: Export Formats
 * Tests all export formats (JSON, CSV, HTML, SARIF)
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  âœ… ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  âŒ ${name}: ${error.message}`);
  }
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('ðŸ“¤ PHASE 3 TEST: Export Formats');
  console.log('='.repeat(60) + '\n');

  // JSON Export
  console.log('Testing JSON Export:');
  
  await test('JSON - Returns valid JSON', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    if (typeof data !== 'object') throw new Error('Invalid JSON');
    return { keys: Object.keys(data).length };
  });

  await test('JSON - Has vulnerabilities array', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
    const data = await response.json();
    if (!Array.isArray(data.vulnerabilities)) throw new Error('Missing vulnerabilities array');
    return { count: data.vulnerabilities.length };
  });

  await test('JSON - Has metadata', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
    const data = await response.json();
    if (!data.exportedAt) throw new Error('Missing exportedAt');
    return { exportedAt: data.exportedAt };
  });

  await test('JSON - Content-Disposition header', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=json`);
    const disposition = response.headers.get('content-disposition');
    if (!disposition?.includes('filename')) throw new Error('Missing filename in header');
    return { disposition };
  });

  // CSV Export
  console.log('\nTesting CSV Export:');
  
  await test('CSV - Returns text/csv', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=csv`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const contentType = response.headers.get('content-type');
    if (!contentType?.includes('text/csv')) throw new Error(`Wrong content type: ${contentType}`);
    return { contentType };
  });

  await test('CSV - Has header row', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=csv`);
    const text = await response.text();
    const lines = text.split('\n');
    if (lines.length < 1) throw new Error('Empty CSV');
    const headers = lines[0].split(',');
    if (headers.length < 3) throw new Error('Too few columns');
    return { columns: headers.length, firstRow: headers.slice(0, 5) };
  });

  await test('CSV - Data rows present', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=csv`);
    const text = await response.text();
    const lines = text.split('\n').filter(l => l.trim());
    return { rows: lines.length - 1 }; // Minus header
  });

  // HTML Export
  console.log('\nTesting HTML Export:');
  
  await test('HTML - Returns text/html', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=html`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const contentType = response.headers.get('content-type');
    if (!contentType?.includes('text/html')) throw new Error(`Wrong content type: ${contentType}`);
    return { contentType };
  });

  await test('HTML - Has DOCTYPE', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=html`);
    const text = await response.text();
    if (!text.includes('<!DOCTYPE') && !text.includes('<html')) throw new Error('Not valid HTML');
    return { valid: true };
  });

  await test('HTML - Has title', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=html`);
    const text = await response.text();
    if (!text.includes('<title>')) throw new Error('Missing title');
    return { hasTitle: true };
  });

  // SARIF Export
  console.log('\nTesting SARIF Export:');
  
  await test('SARIF - Returns valid JSON', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=sarif`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    if (typeof data !== 'object') throw new Error('Invalid JSON');
    return { valid: true };
  });

  await test('SARIF - Has $schema', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=sarif`);
    const data = await response.json();
    if (!data.$schema) throw new Error('Missing $schema');
    return { schema: data.$schema };
  });

  await test('SARIF - Has version', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=sarif`);
    const data = await response.json();
    if (!data.version) throw new Error('Missing version');
    return { version: data.version };
  });

  await test('SARIF - Has runs array', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=sarif`);
    const data = await response.json();
    if (!Array.isArray(data.runs)) throw new Error('Missing runs array');
    return { runs: data.runs.length };
  });

  // Edge Cases
  console.log('\nTesting Edge Cases:');
  
  await test('Invalid format returns error', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export?format=invalid`);
    // Should return 400 or default to JSON
    return { status: response.status };
  });

  await test('No format defaults to JSON', async () => {
    const response = await fetch(`${BASE_URL}/api/phase2/export`);
    const data = await response.json();
    if (typeof data !== 'object') throw new Error('Should default to JSON');
    return { defaulted: true };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`Results: ${passed}/${results.length} passed`);
  console.log(`Total Time: ${(totalTime / 1000).toFixed(1)}s`);

  if (failed > 0) {
    console.log('\nâŒ Failed:');
    results.filter(r => !r.passed).forEach(r => console.log(`  - ${r.name}: ${r.error}`));
    process.exit(1);
  } else {
    console.log('\nâœ… All export tests passed!');
  }
}

runTests().catch(console.error);
