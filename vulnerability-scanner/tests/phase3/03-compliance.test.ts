/**
 * Phase 3 Test: Compliance Reports
 * Tests PCI DSS, OWASP Top 10, and CIS Controls compliance
 */

const BASE_URL = 'http://localhost:3000';

interface TestResult {
  name: string;
  passed: boolean;
  duration: number;
  details?: any;
  error?: string;
}

const results: TestResult[] = [];

async function test(name: string, fn: () => Promise<any>): Promise<void> {
  const start = Date.now();
  try {
    const details = await fn();
    results.push({ name, passed: true, duration: Date.now() - start, details });
    console.log(`  ‚úÖ ${name} (${Date.now() - start}ms)`);
  } catch (error: any) {
    results.push({ name, passed: false, duration: Date.now() - start, error: error.message });
    console.log(`  ‚ùå ${name}: ${error.message}`);
  }
}

async function fetchJSON(url: string): Promise<any> {
  const response = await fetch(url);
  return response.json();
}

async function runTests() {
  console.log('\n' + '='.repeat(60));
  console.log('üìã PHASE 3 TEST: Compliance Reports');
  console.log('='.repeat(60) + '\n');

  // List Frameworks
  console.log('Testing Framework Listing:');
  
  await test('List all frameworks', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?list=true`);
    if (!data.success) throw new Error('API failed');
    if (!data.frameworks || data.frameworks.length === 0) throw new Error('No frameworks');
    return { count: data.frameworks.length, names: data.frameworks.map((f: any) => f.name) };
  });

  // PCI DSS
  console.log('\nTesting PCI DSS:');
  
  await test('PCI DSS - Report generated', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    if (!data.success) throw new Error('API failed');
    if (!data.report) throw new Error('No report');
    return { framework: data.report.framework };
  });

  await test('PCI DSS - Has summary', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    const summary = data.report?.summary;
    if (!summary) throw new Error('No summary');
    if (summary.complianceScore === undefined) throw new Error('No compliance score');
    return { score: summary.complianceScore, total: summary.totalRequirements };
  });

  await test('PCI DSS - Has requirements', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    const requirements = data.report?.requirements;
    if (!requirements || requirements.length === 0) throw new Error('No requirements');
    return { count: requirements.length };
  });

  await test('PCI DSS - Requirements have status', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=PCI%20DSS`);
    const requirements = data.report?.requirements || [];
    const validStatuses = ['pass', 'fail', 'warning', 'not_applicable'];
    const invalid = requirements.filter((r: any) => !validStatuses.includes(r.status));
    if (invalid.length > 0) throw new Error('Invalid status found');
    return { valid: requirements.length };
  });

  // OWASP Top 10
  console.log('\nTesting OWASP Top 10:');
  
  await test('OWASP - Report generated', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    if (!data.success) throw new Error('API failed');
    if (!data.report) throw new Error('No report');
    return { framework: data.report.framework };
  });

  await test('OWASP - Has 10 categories', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    const requirements = data.report?.requirements || [];
    if (requirements.length !== 10) throw new Error(`Expected 10, got ${requirements.length}`);
    return { count: requirements.length };
  });

  await test('OWASP - Categories are A01-A10', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=OWASP%20Top%2010`);
    const requirements = data.report?.requirements || [];
    const ids = requirements.map((r: any) => r.id);
    const expected = ['A01', 'A02', 'A03', 'A04', 'A05', 'A06', 'A07', 'A08', 'A09', 'A10'];
    const missing = expected.filter(e => !ids.includes(e));
    if (missing.length > 0) throw new Error(`Missing: ${missing.join(', ')}`);
    return { ids };
  });

  // CIS Controls
  console.log('\nTesting CIS Controls:');
  
  await test('CIS - Report generated', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=CIS%20Controls`);
    if (!data.success) throw new Error('API failed');
    if (!data.report) throw new Error('No report');
    return { framework: data.report.framework };
  });

  await test('CIS - Has controls', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=CIS%20Controls`);
    const requirements = data.report?.requirements || [];
    if (requirements.length === 0) throw new Error('No controls');
    return { count: requirements.length };
  });

  await test('CIS - Has compliance score', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=CIS%20Controls`);
    const score = data.report?.summary?.complianceScore;
    if (score === undefined) throw new Error('No score');
    if (score < 0 || score > 100) throw new Error(`Invalid score: ${score}`);
    return { score };
  });

  // Edge Cases
  console.log('\nTesting Edge Cases:');
  
  await test('Invalid framework handled', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance?framework=INVALID`);
    // Should return error or empty report
    return { handled: true };
  });

  await test('No framework parameter', async () => {
    const data = await fetchJSON(`${BASE_URL}/api/phase2/compliance`);
    // Should return list or error
    return { handled: true };
  });

  // Summary
  console.log('\n' + '='.repeat(60));
  const passed = results.filter(r => r.passed).length;
  const failed = results.filter(r => !r.passed).length;
  const totalTime = results.reduce((sum, r) => sum + r.duration, 0);
  
  console.log(`Results: ${passed}/${results.length} passed`);
  console.log(`Total Time: ${(totalTime / 1000).toFixed(1)}s`);

  if (failed > 0) {
    console.log('\n‚ùå Failed:');
    results.filter(r => !r.passed).forEach(r => console.log(`  - ${r.name}: ${r.error}`));
    process.exit(1);
  } else {
    console.log('\n‚úÖ All compliance tests passed!');
  }
}

runTests().catch(console.error);
