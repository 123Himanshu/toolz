const { spawn } = require('child_process');

console.log('Testing Docker execution with environment info...\n');

console.log('CWD:', process.cwd());
console.log('PATH:', process.env.PATH?.substring(0, 200));
console.log('DOCKER_HOST:', process.env.DOCKER_HOST || 'not set');
console.log('');

const isWindows = process.platform === 'win32';
const command = 'docker run --rm -i security-scanner python3 -c "print(123)"';

const shell = isWindows ? 'powershell.exe' : '/bin/sh';
const shellArgs = isWindows ? ['-NoProfile', '-Command', command] : ['-c', command];

console.log('Shell:', shell);
console.log('Args:', shellArgs);
console.log('');

const proc = spawn(shell, shellArgs, {
  windowsHide: true,
  stdio: ['pipe', 'pipe', 'pipe'],
  env: process.env,  // Explicitly pass environment
});

proc.stdin.end();

let stdout = '';
let stderr = '';

proc.stdout.on('data', (data) => {
  stdout += data.toString();
});

proc.stderr.on('data', (data) => {
  stderr += data.toString();
});

proc.on('close', (code) => {
  console.log('stdout:', stdout.trim());
  console.log('stderr:', stderr.trim());
  console.log('exit code:', code);
});
