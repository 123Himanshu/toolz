/**
 * Database Module Index
 * Exports all database clients and provides unified initialization
 */

// PostgreSQL - named exports to avoid conflicts
export { 
  getPool, 
  query, 
  queryOne, 
  transaction, 
  initializeDatabase as initPostgresDB,
  healthCheck as postgresHealthCheck 
} from './postgres';
export { default as postgres } from './postgres';

// MongoDB - named exports
export {
  getClient as getMongoClient,
  getDb,
  getCollection,
  COLLECTIONS,
  storeRawOutput,
  getRawOutput,
  getRawOutputsByScan,
  logScanEvent,
  getScanLogs,
  storeToolOutput,
  getToolOutputs,
  cacheEnrichment,
  getCachedEnrichment,
  storeAttackGraph,
  getAttackGraph,
  storeZeroDayIndicator,
  getZeroDayIndicators,
  logAuditEvent,
  initializeMongoDB,
  healthCheck as mongoHealthCheck,
  closeConnection as closeMongoConnection
} from './mongodb';
export { default as mongodb } from './mongodb';

// Redis - named exports
export {
  getRedisClient,
  cacheSet,
  cacheGet,
  cacheDelete,
  cacheDeletePattern,
  enqueueJob,
  dequeueJob,
  completeJob,
  failJob,
  getJob,
  getQueueStats,
  checkRateLimit,
  createSession,
  getSession as getRedisSession,
  deleteSession as deleteRedisSession,
  deleteUserSessions,
  publish,
  subscribe,
  healthCheck as redisHealthCheck,
  closeConnection as closeRedisConnection
} from './redis';
export { default as redis } from './redis';

// Elasticsearch - named exports
export {
  getClient as getElasticClient,
  indexDocument,
  bulkIndex,
  getDocument as getElasticDocument,
  deleteDocument,
  search as elasticSearch,
  searchVulnerabilities,
  searchAssets,
  getVulnerabilityStats,
  initializeIndices,
  healthCheck as elasticHealthCheck,
  deleteIndex,
  INDICES
} from './elasticsearch';
export { default as elasticsearch } from './elasticsearch';

// ============================================================================
// UNIFIED INITIALIZATION
// ============================================================================

import { initializeDatabase as initPostgres, healthCheck as pgHealth } from './postgres';
import { initializeMongoDB, healthCheck as mongoHealth } from './mongodb';
import { healthCheck as redisHealth } from './redis';
import { initializeIndices, healthCheck as esHealth } from './elasticsearch';

// Re-export types
export type { RawOutput, ScanLog, ToolOutput, EnrichmentCache, AttackGraphDoc, ZeroDayIndicatorDoc, AuditEvent } from './mongodb';

export interface DatabaseStatus {
  postgres: boolean;
  mongodb: boolean;
  redis: boolean;
  elasticsearch: boolean;
  overall: boolean;
}

/**
 * Initialize all databases
 */
export async function initializeAllDatabases(): Promise<{
  success: boolean;
  errors: string[];
}> {
  const errors: string[] = [];

  console.log('üîß Initializing all databases...\n');

  // PostgreSQL
  try {
    console.log('üì¶ Initializing PostgreSQL...');
    await initPostgres();
    console.log('‚úÖ PostgreSQL initialized\n');
  } catch (error: any) {
    console.error('‚ùå PostgreSQL initialization failed:', error.message);
    errors.push(`PostgreSQL: ${error.message}`);
  }

  // MongoDB
  try {
    console.log('üì¶ Initializing MongoDB...');
    await initializeMongoDB();
    console.log('‚úÖ MongoDB initialized\n');
  } catch (error: any) {
    console.error('‚ùå MongoDB initialization failed:', error.message);
    errors.push(`MongoDB: ${error.message}`);
  }

  // Elasticsearch (optional - may not be running)
  let esAvailable = false;
  try {
    console.log('üì¶ Initializing Elasticsearch...');
    const esHealthy = await esHealth();
    if (esHealthy) {
      await initializeIndices();
      esAvailable = true;
      console.log('‚úÖ Elasticsearch initialized\n');
    } else {
      console.warn('‚ö†Ô∏è Elasticsearch not available (optional)\n');
    }
  } catch (error: any) {
    console.warn('‚ö†Ô∏è Elasticsearch initialization skipped:', error.message);
    // Don't add to errors - ES is optional
  }

  // Redis health check (no initialization needed)
  try {
    console.log('üì¶ Checking Redis connection...');
    const redisOk = await redisHealth();
    if (redisOk) {
      console.log('‚úÖ Redis connected\n');
    } else {
      console.warn('‚ö†Ô∏è Redis not available (optional)\n');
    }
  } catch (error: any) {
    console.warn('‚ö†Ô∏è Redis not available:', error.message);
  }

  console.log('üîß Database initialization complete\n');

  return {
    success: errors.length === 0,
    errors,
  };
}

/**
 * Check health of all databases
 */
export async function checkAllDatabaseHealth(): Promise<DatabaseStatus> {
  const [postgres, mongodb, redis, elasticsearch] = await Promise.all([
    pgHealth().catch(() => false),
    mongoHealth().catch(() => false),
    redisHealth().catch(() => false),
    esHealth().catch(() => false),
  ]);

  return {
    postgres,
    mongodb,
    redis,
    elasticsearch,
    overall: postgres && mongodb, // Core databases must be healthy
  };
}

/**
 * Get database connection info (for debugging)
 */
export function getDatabaseConfig(): {
  postgres: string;
  mongodb: string;
  redis: string;
  elasticsearch: string;
} {
  return {
    postgres: process.env.DATABASE_URL ? '‚úì Configured' : '‚úó Not configured',
    mongodb: process.env.MONGODB_URI ? '‚úì Configured' : '‚úó Not configured',
    redis: process.env.REDIS_URL || 'redis://localhost:6379',
    elasticsearch: process.env.ELASTICSEARCH_URL || 'http://localhost:9200',
  };
}
