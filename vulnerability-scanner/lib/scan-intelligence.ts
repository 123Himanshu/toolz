/**
 * SMART Scan Intelligence Engine
 * AI-powered tool recommendation with ZERO duplication
 * 
 * Strategy:
 * - Core tools: 100% integration (Nmap, Nuclei, Wapiti, Trivy, OpenVAS)
 * - Partial tools: Only unique features (RustScan, Masscan, Nikto, etc.)
 */

export interface ToolRecommendation {
  toolId: string;
  category: 'network' | 'web' | 'system';
  confidence: number;
  reason: string;
  role: 'core' | 'speed' | 'scale' | 'specialized';
}

export interface ScanRecommendation {
  targetType: string;
  detectedTechnology?: string;
  recommendedTools: ToolRecommendation[];
  scanType: 'passive' | 'active' | 'both';
  estimatedDuration: string;
  riskLevel: 'low' | 'medium' | 'high';
  aiInsight?: string;
  smartSelection: boolean;
  reasoning: string;
}

/**
 * SMART target analysis - selects optimal tools with ZERO duplication
 * Now uses the smart target parser for better detection
 */
export function analyzeTarget(target: string): ScanRecommendation {
  const trimmedTarget = target.trim().toLowerCase();
  
  // Use smart parser for better detection
  try {
    const { parseTarget: smartParse } = require('./target-parser');
    const parsed = smartParse(target);
    
    switch (parsed.type) {
      case 'url':
        return analyzeWebTarget(trimmedTarget);
      case 'cidr':
        return analyzeCIDRTarget(trimmedTarget);
      case 'ip':
        return analyzeIPTarget(trimmedTarget);
      case 'domain':
        return analyzeDomainTarget(trimmedTarget);
      case 'container':
        return analyzeContainerTarget(trimmedTarget);
      default:
        return getDefaultRecommendation();
    }
  } catch (e) {
    // Fallback to old logic if parser fails
    if (trimmedTarget.startsWith('http://') || trimmedTarget.startsWith('https://')) {
      return analyzeWebTarget(trimmedTarget);
    }
    if (isCIDR(trimmedTarget)) {
      return analyzeCIDRTarget(trimmedTarget);
    }
    if (isIPAddress(trimmedTarget)) {
      return analyzeIPTarget(trimmedTarget);
    }
    if (isDomain(trimmedTarget)) {
      return analyzeDomainTarget(trimmedTarget);
    }
    return getDefaultRecommendation();
  }
}

/**
 * SMART Web Application Analysis
 * Core: Nuclei (CVE), Wapiti (web vulnerabilities), Nmap (service detection)
 * Speed: RustScan (port discovery)
 * Specialized: Nikto (if legacy server detected)
 */
function analyzeWebTarget(target: string): ScanRecommendation {
  const recommendations: ToolRecommendation[] = [];
  
  // SPEED: RustScan for ultra-fast port discovery
  recommendations.push({
    toolId: 'rustscan',
    category: 'network',
    confidence: 0.95,
    reason: 'Ultra-fast port discovery (3 sec) - feeds discovered ports to Nmap',
    role: 'speed'
  });
  
  // CORE: Nmap for service detection (uses RustScan results)
  recommendations.push({
    toolId: 'nmap',
    category: 'network',
    confidence: 0.95,
    reason: 'Core network scanner - service detection on RustScan ports',
    role: 'core'
  });
  
  // CORE: Nuclei for CVE scanning
  recommendations.push({
    toolId: 'nuclei',
    category: 'web',
    confidence: 0.95,
    reason: 'Core CVE scanner - 5000+ templates (NOT Jaeles - Nuclei has more)',
    role: 'core'
  });
  
  // WEB: Wapiti for web vulnerability scanning
  recommendations.push({
    toolId: 'wapiti',
    category: 'web',
    confidence: 0.85,
    reason: 'Web vulnerability scanner - XSS/SQLi/LFI checks',
    role: 'core'
  });
  
  // SPECIALIZED: Nikto ONLY if legacy server suspected
  if (target.includes('apache') || target.includes('iis') || target.match(/\d+\.\d+\.\d+\.\d+/)) {
    recommendations.push({
      toolId: 'nikto',
      category: 'web',
      confidence: 0.70,
      reason: 'Legacy server misconfiguration checks (Apache 2.2, IIS 6)',
      role: 'specialized'
    });
  }
  
  // CORE SYSTEM TOOLS
  recommendations.push({
    toolId: 'trivy',
    category: 'system',
    confidence: 0.90,
    reason: 'Core container/IaC scanner - comprehensive vulnerability detection',
    role: 'core'
  });
  
  recommendations.push({
    toolId: 'openvas',
    category: 'system',
    confidence: 0.85,
    reason: 'Core enterprise CVE scanner - 50,000+ tests',
    role: 'core'
  });

  // Detect specific technologies
  let detectedTech = 'Web Application';
  let reasoning = 'Web target: RustScan→Nmap (ports), Nuclei (CVE), Wapiti (web vulnerabilities). Zero duplication.';
  
  if (target.includes('wordpress') || target.includes('wp-')) {
    detectedTech = 'WordPress Site';
    reasoning = 'WordPress: Using Nuclei (has WP templates), NOT Jaeles. ' + reasoning;
  } else if (target.includes('api')) {
    detectedTech = 'REST API';
    reasoning = 'API: Using Nuclei for API testing. ' + reasoning;
  }

  return {
    targetType: 'Web Application',
    detectedTechnology: detectedTech,
    recommendedTools: recommendations,
    scanType: 'both',
    estimatedDuration: '8-15 minutes',
    riskLevel: 'medium',
    smartSelection: true,
    reasoning
  };
}

/**
 * SMART IP Address Analysis
 * Speed: RustScan (ONLY for single IPs)
 * Core: Nmap (service detection)
 * NO Masscan (wrong tool for single IPs)
 */
function analyzeIPTarget(target: string): ScanRecommendation {
  const recommendations: ToolRecommendation[] = [];
  
  // SPEED: RustScan for single IP fast discovery
  recommendations.push({
    toolId: 'rustscan',
    category: 'network',
    confidence: 0.95,
    reason: 'Ultra-fast port discovery for single IP (NOT Masscan - wrong tool)',
    role: 'speed'
  });
  
  // CORE: Nmap for deep analysis
  recommendations.push({
    toolId: 'nmap',
    category: 'network',
    confidence: 0.98,
    reason: 'Core network scanner - service detection on RustScan ports',
    role: 'core'
  });
  
  // CORE: Nuclei for web services
  recommendations.push({
    toolId: 'nuclei',
    category: 'web',
    confidence: 0.75,
    reason: 'Core CVE scanner - checks web services (NOT Jaeles)',
    role: 'core'
  });
  
  // CORE SYSTEM TOOLS
  recommendations.push({
    toolId: 'trivy',
    category: 'system',
    confidence: 0.85,
    reason: 'Core system scanner - comprehensive vulnerability detection',
    role: 'core'
  });
  
  recommendations.push({
    toolId: 'openvas',
    category: 'system',
    confidence: 0.85,
    reason: 'Core CVE scanner - 50,000+ tests',
    role: 'core'
  });

  return {
    targetType: 'IP Address',
    detectedTechnology: 'Network Host',
    recommendedTools: recommendations,
    scanType: 'active',
    estimatedDuration: '5-12 minutes',
    riskLevel: 'low',
    smartSelection: true,
    reasoning: 'Single IP: RustScan (speed) → Nmap (depth). NOT Masscan (for ranges only).'
  };
}

/**
 * SMART Domain Analysis
 * Speed: RustScan (port discovery), Naabu (if multiple subdomains)
 * Core: Nmap, Nuclei, Wapiti
 */
function analyzeDomainTarget(target: string): ScanRecommendation {
  const recommendations: ToolRecommendation[] = [];
  
  // SPEED: RustScan for port discovery
  recommendations.push({
    toolId: 'rustscan',
    category: 'network',
    confidence: 0.90,
    reason: 'Fast port discovery for domain - feeds to Nmap',
    role: 'speed'
  });
  
  // SPEED: Naabu for clean JSON (if automation needed)
  recommendations.push({
    toolId: 'naabu',
    category: 'network',
    confidence: 0.75,
    reason: 'Clean JSON output for API/automation (web ports only)',
    role: 'speed'
  });
  
  // CORE: Nmap for service detection
  recommendations.push({
    toolId: 'nmap',
    category: 'network',
    confidence: 0.95,
    reason: 'Core network scanner - service detection on discovered ports',
    role: 'core'
  });
  
  // CORE WEB TOOLS
  recommendations.push({
    toolId: 'nuclei',
    category: 'web',
    confidence: 0.90,
    reason: 'Core CVE scanner - 5000+ templates (NOT Jaeles)',
    role: 'core'
  });
  
  // CORE SYSTEM TOOLS
  recommendations.push({
    toolId: 'trivy',
    category: 'system',
    confidence: 0.85,
    reason: 'Core system scanner - comprehensive vulnerability detection',
    role: 'core'
  });
  
  recommendations.push({
    toolId: 'openvas',
    category: 'system',
    confidence: 0.85,
    reason: 'Core CVE scanner - 50,000+ tests',
    role: 'core'
  });

  return {
    targetType: 'Domain',
    detectedTechnology: 'Domain Name',
    recommendedTools: recommendations,
    scanType: 'both',
    estimatedDuration: '8-15 minutes',
    riskLevel: 'medium',
    smartSelection: true,
    reasoning: 'Domain: RustScan→Nmap (ports), Nuclei (CVE), Wapiti (web vulnerabilities). Naabu for JSON output.'
  };
}

/**
 * SMART CIDR Range Analysis
 * Scale: Masscan (ONLY for large ranges)
 * Core: Nmap (detailed analysis)
 * NO RustScan (Masscan better for ranges)
 */
function analyzeCIDRTarget(target: string): ScanRecommendation {
  const recommendations: ToolRecommendation[] = [];
  
  // SCALE: Masscan for large CIDR ranges ONLY
  recommendations.push({
    toolId: 'masscan',
    category: 'network',
    confidence: 0.98,
    reason: 'Internet-scale scanner for /16, /24 networks (NOT RustScan - wrong tool)',
    role: 'scale'
  });
  
  // CORE: Nmap for detailed analysis of discovered IPs
  recommendations.push({
    toolId: 'nmap',
    category: 'network',
    confidence: 0.95,
    reason: 'Core network scanner - service detection on Masscan-discovered hosts',
    role: 'core'
  });
  
  // CORE SYSTEM TOOLS
  recommendations.push({
    toolId: 'trivy',
    category: 'system',
    confidence: 0.80,
    reason: 'Core system scanner - vulnerability assessment',
    role: 'core'
  });
  
  recommendations.push({
    toolId: 'openvas',
    category: 'system',
    confidence: 0.80,
    reason: 'Core CVE scanner - comprehensive testing',
    role: 'core'
  });

  return {
    targetType: 'IP Range',
    detectedTechnology: 'Network Range',
    recommendedTools: recommendations,
    scanType: 'active',
    estimatedDuration: '15-45 minutes',
    riskLevel: 'high',
    smartSelection: true,
    reasoning: 'CIDR range: Masscan (scale) → Nmap (depth). NOT using RustScan (wrong tool for ranges).'
  };
}

/**
 * SMART Container Analysis
 * Core: Trivy (container scanning)
 */
function analyzeContainerTarget(target: string): ScanRecommendation {
  const recommendations: ToolRecommendation[] = [];
  
  // CORE: Trivy for container scanning
  recommendations.push({
    toolId: 'trivy',
    category: 'system',
    confidence: 0.98,
    reason: 'Core container scanner - CVE detection in images',
    role: 'core'
  });

  return {
    targetType: 'Container Image',
    detectedTechnology: 'Docker/OCI Image',
    recommendedTools: recommendations,
    scanType: 'active',
    estimatedDuration: '2-5 minutes',
    riskLevel: 'medium',
    smartSelection: true,
    reasoning: 'Container image: Using Trivy for comprehensive CVE scanning.'
  };
}

/**
 * Default recommendation for unknown targets
 */
function getDefaultRecommendation(): ScanRecommendation {
  return {
    targetType: 'Unknown',
    recommendedTools: [
      {
        toolId: 'nmap',
        category: 'network',
        confidence: 0.85,
        reason: 'Core network scanner - versatile for initial reconnaissance',
        role: 'core'
      },
      {
        toolId: 'nuclei',
        category: 'web',
        confidence: 0.80,
        reason: 'Core CVE scanner - broad vulnerability coverage',
        role: 'core'
      },
      {
        toolId: 'trivy',
        category: 'system',
        confidence: 0.75,
        reason: 'Core system scanner - container and filesystem scanning',
        role: 'core'
      }
    ],
    scanType: 'active',
    estimatedDuration: '5-10 minutes',
    riskLevel: 'medium',
    smartSelection: true,
    reasoning: 'Unknown target type. Using core tools for comprehensive coverage.'
  };
}

/**
 * Validation helpers
 */
function isIPAddress(target: string): boolean {
  const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
  const ipv6Regex = /^([0-9a-fA-F]{0,4}:){7}[0-9a-fA-F]{0,4}$/;
  return ipv4Regex.test(target) || ipv6Regex.test(target);
}

function isDomain(target: string): boolean {
  const domainRegex = /^([a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/;
  return domainRegex.test(target);
}

function isCIDR(target: string): boolean {
  const cidrRegex = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;
  return cidrRegex.test(target);
}

/**
 * Validate target input
 */
export function validateTarget(target: string): { valid: boolean; error?: string } {
  const trimmed = target.trim();
  
  if (!trimmed) {
    return { valid: false, error: 'Target cannot be empty' };
  }
  
  if (trimmed.length < 3) {
    return { valid: false, error: 'Target too short' };
  }
  
  if (trimmed.length > 255) {
    return { valid: false, error: 'Target too long' };
  }
  
  // Check for valid format
  const isValid = 
    trimmed.startsWith('http://') ||
    trimmed.startsWith('https://') ||
    isIPAddress(trimmed) ||
    isDomain(trimmed) ||
    isCIDR(trimmed);
  
  if (!isValid) {
    return { 
      valid: false, 
      error: 'Invalid format. Use URL, IP, domain, or CIDR notation' 
    };
  }
  
  return { valid: true };
}

