/**
 * Authentication Middleware
 * Protects API routes and validates tokens
 */

import { NextRequest, NextResponse } from 'next/server';
import { verifyToken, extractTokenFromHeader, hasPermission } from './auth';

export interface AuthenticatedRequest extends NextRequest {
  user?: {
    id: string;
    email: string;
    role: string;
  };
}

/**
 * Middleware to verify authentication
 */
export async function withAuth(
  request: NextRequest,
  handler: (req: AuthenticatedRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  // Get token from cookie or header
  const cookieToken = request.cookies.get('auth_token')?.value;
  const headerToken = extractTokenFromHeader(request.headers.get('authorization') || undefined);
  const token = cookieToken || headerToken;

  if (!token) {
    return NextResponse.json(
      { success: false, error: 'Authentication required' },
      { status: 401 }
    );
  }

  const verification = await verifyToken(token);

  if (!verification.valid || !verification.user) {
    return NextResponse.json(
      { success: false, error: verification.error || 'Invalid token' },
      { status: 401 }
    );
  }

  // Add user to request
  const authenticatedRequest = request as AuthenticatedRequest;
  authenticatedRequest.user = {
    id: verification.user.id,
    email: verification.user.email,
    role: verification.user.role,
  };

  return handler(authenticatedRequest);
}

/**
 * Middleware to verify authentication and permission
 */
export async function withPermission(
  request: NextRequest,
  permission: string,
  handler: (req: AuthenticatedRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  return withAuth(request, async (req) => {
    if (!req.user) {
      return NextResponse.json(
        { success: false, error: 'Authentication required' },
        { status: 401 }
      );
    }

    if (!hasPermission(req.user.role, permission)) {
      return NextResponse.json(
        { success: false, error: 'Permission denied' },
        { status: 403 }
      );
    }

    return handler(req);
  });
}

/**
 * Optional auth - doesn't fail if not authenticated
 */
export async function withOptionalAuth(
  request: NextRequest,
  handler: (req: AuthenticatedRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  const cookieToken = request.cookies.get('auth_token')?.value;
  const headerToken = extractTokenFromHeader(request.headers.get('authorization') || undefined);
  const token = cookieToken || headerToken;

  const authenticatedRequest = request as AuthenticatedRequest;

  if (token) {
    const verification = await verifyToken(token);
    
    if (verification.valid && verification.user) {
      authenticatedRequest.user = {
        id: verification.user.id,
        email: verification.user.email,
        role: verification.user.role,
      };
    }
  }

  return handler(authenticatedRequest);
}

/**
 * Check if request is authenticated (for client-side)
 */
export async function isAuthenticated(request: NextRequest): Promise<boolean> {
  const cookieToken = request.cookies.get('auth_token')?.value;
  const headerToken = extractTokenFromHeader(request.headers.get('authorization') || undefined);
  const token = cookieToken || headerToken;

  if (!token) return false;

  const verification = await verifyToken(token);
  return verification.valid;
}
