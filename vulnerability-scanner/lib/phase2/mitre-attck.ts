/**
 * MITRE ATT&CK Technique Mapping
 * Maps vulnerabilities to ATT&CK techniques
 */

import { NormalizedVulnerability } from './types';

export interface ATTCKTechnique {
  id: string;
  name: string;
  tactic: string;
  url: string;
}

// ATT&CK Technique Database
const ATTCK_TECHNIQUES: Record<string, ATTCKTechnique> = {
  'T1190': { id: 'T1190', name: 'Exploit Public-Facing Application', tactic: 'Initial Access', url: 'https://attack.mitre.org/techniques/T1190' },
  'T1203': { id: 'T1203', name: 'Exploitation for Client Execution', tactic: 'Execution', url: 'https://attack.mitre.org/techniques/T1203' },
  'T1059': { id: 'T1059', name: 'Command and Scripting Interpreter', tactic: 'Execution', url: 'https://attack.mitre.org/techniques/T1059' },
  'T1068': { id: 'T1068', name: 'Exploitation for Privilege Escalation', tactic: 'Privilege Escalation', url: 'https://attack.mitre.org/techniques/T1068' },
  'T1078': { id: 'T1078', name: 'Valid Accounts', tactic: 'Defense Evasion', url: 'https://attack.mitre.org/techniques/T1078' },
  'T1021': { id: 'T1021', name: 'Remote Services', tactic: 'Lateral Movement', url: 'https://attack.mitre.org/techniques/T1021' },
  'T1021.001': { id: 'T1021.001', name: 'Remote Desktop Protocol', tactic: 'Lateral Movement', url: 'https://attack.mitre.org/techniques/T1021/001' },
  'T1021.002': { id: 'T1021.002', name: 'SMB/Windows Admin Shares', tactic: 'Lateral Movement', url: 'https://attack.mitre.org/techniques/T1021/002' },
  'T1005': { id: 'T1005', name: 'Data from Local System', tactic: 'Collection', url: 'https://attack.mitre.org/techniques/T1005' },
  'T1083': { id: 'T1083', name: 'File and Directory Discovery', tactic: 'Discovery', url: 'https://attack.mitre.org/techniques/T1083' },
  'T1189': { id: 'T1189', name: 'Drive-by Compromise', tactic: 'Initial Access', url: 'https://attack.mitre.org/techniques/T1189' },
  'T1090': { id: 'T1090', name: 'Proxy', tactic: 'Command and Control', url: 'https://attack.mitre.org/techniques/T1090' },
  'T1548': { id: 'T1548', name: 'Abuse Elevation Control Mechanism', tactic: 'Privilege Escalation', url: 'https://attack.mitre.org/techniques/T1548' },
  'T1213': { id: 'T1213', name: 'Data from Information Repositories', tactic: 'Collection', url: 'https://attack.mitre.org/techniques/T1213' },
  'T1110': { id: 'T1110', name: 'Brute Force', tactic: 'Credential Access', url: 'https://attack.mitre.org/techniques/T1110' },
  'T1133': { id: 'T1133', name: 'External Remote Services', tactic: 'Initial Access', url: 'https://attack.mitre.org/techniques/T1133' },
};

// CWE to ATT&CK Mapping
const CWE_TO_ATTCK: Record<string, string[]> = {
  'CWE-22': ['T1083'],           // Path Traversal
  'CWE-78': ['T1059'],           // OS Command Injection
  'CWE-79': ['T1189'],           // XSS
  'CWE-89': ['T1190', 'T1213'],  // SQL Injection
  'CWE-94': ['T1059'],           // Code Injection
  'CWE-119': ['T1203'],          // Buffer Overflow
  'CWE-190': ['T1203'],          // Integer Overflow
  'CWE-200': ['T1005'],          // Information Exposure
  'CWE-269': ['T1068'],          // Privilege Escalation
  'CWE-287': ['T1078'],          // Authentication Bypass
  'CWE-502': ['T1203'],          // Deserialization
  'CWE-521': ['T1110'],          // Weak Password
  'CWE-918': ['T1090'],          // SSRF
};

// Service to ATT&CK Mapping
const SERVICE_TO_ATTCK: Record<string, string[]> = {
  'http': ['T1190'],
  'https': ['T1190'],
  'ssh': ['T1021', 'T1133'],
  'rdp': ['T1021.001', 'T1133'],
  'smb': ['T1021.002'],
  'ftp': ['T1133'],
  'telnet': ['T1021', 'T1133'],
  'mysql': ['T1190'],
  'postgresql': ['T1190'],
  'mssql': ['T1190'],
};

// Keyword to ATT&CK Mapping
const KEYWORD_TO_ATTCK: Record<string, string[]> = {
  'remote code execution': ['T1190', 'T1203'],
  'rce': ['T1190', 'T1203'],
  'sql injection': ['T1190', 'T1213'],
  'sqli': ['T1190', 'T1213'],
  'cross-site scripting': ['T1189'],
  'xss': ['T1189'],
  'privilege escalation': ['T1068', 'T1548'],
  'authentication bypass': ['T1078'],
  'information disclosure': ['T1005', 'T1083'],
  'path traversal': ['T1083'],
  'directory traversal': ['T1083'],
  'command injection': ['T1059'],
  'deserialization': ['T1203'],
  'ssrf': ['T1090'],
  'brute force': ['T1110'],
  'default credentials': ['T1078'],
};

export interface ATTCKMapping {
  techniques: ATTCKTechnique[];
  tactics: string[];
  confidence: number;
}

/**
 * Map a vulnerability to MITRE ATT&CK techniques
 */
export function mapToATTCK(vuln: NormalizedVulnerability): ATTCKMapping {
  const techniqueIds = new Set<string>();
  let confidence = 0;

  // Map by CWE
  if (vuln.cwe && vuln.cwe.length > 0) {
    for (const cwe of vuln.cwe) {
      const techniques = CWE_TO_ATTCK[cwe];
      if (techniques) {
        techniques.forEach(t => techniqueIds.add(t));
        confidence += 30;
      }
    }
  }

  // Map by service
  if (vuln.service) {
    const serviceLower = vuln.service.toLowerCase();
    const techniques = SERVICE_TO_ATTCK[serviceLower];
    if (techniques) {
      techniques.forEach(t => techniqueIds.add(t));
      confidence += 20;
    }
  }

  // Map by keywords in title/description
  const text = `${vuln.title} ${vuln.description}`.toLowerCase();
  for (const [keyword, techniques] of Object.entries(KEYWORD_TO_ATTCK)) {
    if (text.includes(keyword)) {
      techniques.forEach(t => techniqueIds.add(t));
      confidence += 15;
    }
  }

  // Get technique details
  const techniques = Array.from(techniqueIds)
    .map(id => ATTCK_TECHNIQUES[id])
    .filter((t): t is ATTCKTechnique => t !== undefined);

  // Get unique tactics
  const tactics = [...new Set(techniques.map(t => t.tactic))];

  return {
    techniques,
    tactics,
    confidence: Math.min(100, confidence)
  };
}

/**
 * Enrich vulnerabilities with ATT&CK mappings
 */
export function enrichWithATTCK(vulns: NormalizedVulnerability[]): NormalizedVulnerability[] {
  return vulns.map(vuln => {
    const mapping = mapToATTCK(vuln);
    return {
      ...vuln,
      mitreTechniques: mapping.techniques.map(t => t.id),
      mitreTactics: mapping.tactics,
    };
  });
}

/**
 * Get ATT&CK summary for a scan
 */
export function getATTCKSummary(vulns: NormalizedVulnerability[]): {
  techniques: { technique: ATTCKTechnique; count: number }[];
  tactics: { tactic: string; count: number }[];
  coverage: number;
} {
  const techniqueCounts = new Map<string, number>();
  const tacticCounts = new Map<string, number>();

  for (const vuln of vulns) {
    const mapping = mapToATTCK(vuln);
    for (const tech of mapping.techniques) {
      techniqueCounts.set(tech.id, (techniqueCounts.get(tech.id) || 0) + 1);
      tacticCounts.set(tech.tactic, (tacticCounts.get(tech.tactic) || 0) + 1);
    }
  }

  const techniques = Array.from(techniqueCounts.entries())
    .map(([id, count]) => ({ technique: ATTCK_TECHNIQUES[id], count }))
    .filter(t => t.technique)
    .sort((a, b) => b.count - a.count);

  const tactics = Array.from(tacticCounts.entries())
    .map(([tactic, count]) => ({ tactic, count }))
    .sort((a, b) => b.count - a.count);

  // Coverage = unique techniques found / total techniques in database
  const coverage = (techniqueCounts.size / Object.keys(ATTCK_TECHNIQUES).length) * 100;

  return { techniques, tactics, coverage };
}
