/**
 * Phase 2: Unified Vulnerability Schema & Types
 * Canonical data model for all scanner outputs
 */

// ============================================================================
// CORE TYPES - Unified Vulnerability Schema
// ============================================================================

export interface Severity {
  score: number;        // 0-10 CVSS-like score
  label: 'critical' | 'high' | 'medium' | 'low' | 'info';
  cvss?: string;        // Original CVSS vector if available
}

export interface NormalizedVulnerability {
  id: string;                    // Unique ID (generated)
  scanId: string;                // Parent scan ID
  scanner: string;               // Source scanner (nmap, nuclei, etc.)
  scannerCategory: 'network' | 'web' | 'system' | 'recon';
  
  // Target Information
  host: string;                  // IP or hostname
  port?: number;                 // Port number
  protocol?: string;             // tcp, udp, http, https
  service?: string;              // Service name (http, ssh, etc.)
  url?: string;                  // Full URL for web vulns
  
  // Vulnerability Details
  title: string;                 // Vulnerability title
  description: string;           // Detailed description
  severity: Severity;            // Normalized severity
  
  // Identifiers
  cve?: string[];                // CVE IDs
  cwe?: string[];                // CWE IDs
  scannerId?: string;            // Scanner-specific ID (plugin_id, nvt_oid, template_id)
  
  // Evidence & Context
  evidence?: string;             // Proof/evidence of vulnerability
  request?: string;              // HTTP request (for web vulns)
  response?: string;             // HTTP response snippet
  matchedAt?: string;            // Where the vuln was found
  
  // Remediation
  remediation?: string;          // Fix/solution
  references?: string[];         // Reference URLs
  
  // Metadata
  confidence: number;            // 0-100 confidence score
  verified: boolean;             // Manually verified
  falsePositive: boolean;        // Marked as false positive
  
  // Timestamps
  discoveredAt: string;          // ISO timestamp
  updatedAt: string;             // Last update
  
  // Deduplication
  fingerprint: string;           // Hash for deduplication
  duplicateOf?: string;          // ID of original if duplicate
  duplicateCount?: number;       // Number of duplicates found
  
  // Raw data reference
  rawDataRef?: string;           // Reference to raw scanner output
}

// ============================================================================
// HOST & SERVICE INVENTORY
// ============================================================================

export interface DiscoveredHost {
  id: string;
  ip: string;
  hostname?: string;
  mac?: string;
  os?: string;
  osVersion?: string;
  
  // Discovery info
  discoveredBy: string[];        // Which scanners found this host
  firstSeen: string;
  lastSeen: string;
  
  // State
  state: 'up' | 'down' | 'unknown';
  
  // Aggregated data
  openPorts: number[];
  services: string[];
  vulnerabilityCount: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    info: number;
  };
  riskScore: number;             // Calculated risk score
  
  // Tags & metadata
  tags?: string[];
  notes?: string;
}

export interface DiscoveredService {
  id: string;
  hostId: string;
  host: string;
  port: number;
  protocol: string;
  service: string;
  version?: string;
  product?: string;
  
  // Discovery info
  discoveredBy: string[];
  firstSeen: string;
  lastSeen: string;
  
  // State
  state: 'open' | 'closed' | 'filtered';
  
  // Security info
  vulnerabilityCount: number;
  riskScore: number;
  
  // Banner/fingerprint
  banner?: string;
  fingerprint?: string;
}

// ============================================================================
// TECHNOLOGY STACK
// ============================================================================

export interface Technology {
  id: string;
  name: string;
  version?: string;
  category: 'web-server' | 'framework' | 'cms' | 'database' | 'os' | 'language' | 'library' | 'other';
  
  // Where found
  hosts: string[];
  urls?: string[];
  
  // Discovery
  discoveredBy: string[];
  confidence: number;
  
  // Known vulnerabilities
  knownCves?: string[];
  riskLevel: 'critical' | 'high' | 'medium' | 'low' | 'none';
}

// ============================================================================
// SCAN SESSION
// ============================================================================

export interface ScanSession {
  id: string;
  target: string;
  scanType: 'active' | 'passive' | 'mixed';
  
  // Tools used
  tools: string[];
  toolResults: Record<string, 'success' | 'failed' | 'partial'>;
  
  // Timing
  startedAt: string;
  completedAt?: string;
  duration?: number;
  
  // Results summary
  hostsDiscovered: number;
  servicesDiscovered: number;
  vulnerabilitiesFound: number;
  
  // Severity breakdown
  severityBreakdown: {
    critical: number;
    high: number;
    medium: number;
    low: number;
    info: number;
  };
  
  // Deduplication stats
  totalFindings: number;
  uniqueFindings: number;
  duplicatesRemoved: number;
  
  // Risk score
  overallRiskScore: number;
}

// ============================================================================
// ATTACK PATH
// ============================================================================

export interface AttackPathNode {
  id: string;
  type: 'host' | 'service' | 'vulnerability' | 'credential' | 'data';
  label: string;
  data: Record<string, any>;
  riskScore: number;
}

export interface AttackPathEdge {
  id: string;
  source: string;
  target: string;
  type: 'exploits' | 'leads_to' | 'requires' | 'enables';
  label: string;
  probability: number;  // 0-1 likelihood
}

export interface AttackPath {
  id: string;
  scanId: string;
  name: string;
  description: string;
  
  // Graph structure
  nodes: AttackPathNode[];
  edges: AttackPathEdge[];
  
  // Path analysis
  entryPoints: string[];         // Starting node IDs
  targets: string[];             // Target node IDs (crown jewels)
  criticalPath: string[];        // Most likely path (node IDs)
  
  // Risk assessment
  overallRisk: number;
  exploitability: number;
  impact: number;
  
  // Recommendations
  mitigations: string[];
  prioritizedFixes: string[];
}

// ============================================================================
// CORRELATION & ENRICHMENT
// ============================================================================

export interface ThreatIntelligence {
  cve: string;
  
  // NVD data
  nvdScore?: number;
  nvdVector?: string;
  nvdDescription?: string;
  
  // Exploit info
  exploitAvailable: boolean;
  exploitDbId?: string;
  metasploitModule?: string;
  
  // Threat context
  inTheWild: boolean;
  ransomwareAssociated: boolean;
  aptAssociated: boolean;
  
  // Dates
  publishedDate?: string;
  lastModified?: string;
  
  // References
  references: string[];
}

export interface CorrelatedFinding {
  vulnerabilityId: string;
  
  // Cross-scanner correlation
  confirmedBy: string[];         // Other scanners that found same issue
  conflictsWith?: string[];      // Scanners with different findings
  
  // Threat intelligence
  threatIntel?: ThreatIntelligence;
  
  // Related findings
  relatedVulnerabilities: string[];  // IDs of related vulns
  affectedHosts: string[];
  
  // Confidence boost
  correlatedConfidence: number;  // Adjusted confidence after correlation
}

// ============================================================================
// QUERY & FILTER TYPES
// ============================================================================

export interface VulnerabilityQuery {
  // Filters
  scanId?: string;
  scanner?: string | string[];
  host?: string;
  port?: number;
  severity?: Severity['label'] | Severity['label'][];
  cve?: string;
  
  // Search
  search?: string;               // Full-text search
  
  // Deduplication
  uniqueOnly?: boolean;          // Exclude duplicates
  includeFalsePositives?: boolean;
  
  // Pagination
  page?: number;
  limit?: number;
  
  // Sorting
  sortBy?: 'severity' | 'host' | 'scanner' | 'discoveredAt';
  sortOrder?: 'asc' | 'desc';
}

export interface QueryResult<T> {
  data: T[];
  total: number;
  page: number;
  limit: number;
  hasMore: boolean;
}

// ============================================================================
// RISK SCORING
// ============================================================================

export interface RiskFactors {
  cvssScore: number;             // Base CVSS (0-10)
  exposureScore: number;         // Internet exposure (0-10)
  reachabilityScore: number;     // Lateral movement potential (0-10)
  exploitabilityScore: number;   // Exploit availability (0-10)
  assetCriticality: number;      // Asset importance (0-10)
}

export interface RiskScore {
  overall: number;               // 0-100 composite score
  factors: RiskFactors;
  label: 'critical' | 'high' | 'medium' | 'low';
  trend: 'increasing' | 'stable' | 'decreasing';
}
