/**
 * Compliance Mapping Module
 * Maps vulnerabilities to compliance frameworks (PCI DSS, OWASP Top 10, CIS, NIST)
 */

import { NormalizedVulnerability } from './types';

// Compliance Framework Definitions
export interface ComplianceRequirement {
  id: string;
  name: string;
  description: string;
  category: string;
}

export interface ComplianceMapping {
  framework: string;
  version: string;
  requirements: ComplianceRequirement[];
}

export interface VulnerabilityComplianceResult {
  vulnId: string;
  vulnTitle: string;
  mappings: {
    framework: string;
    requirements: string[];
    severity: 'pass' | 'fail' | 'warning';
  }[];
}

export interface ComplianceReport {
  framework: string;
  version: string;
  scanId?: string;
  generatedAt: string;
  summary: {
    totalRequirements: number;
    passed: number;
    failed: number;
    warnings: number;
    notApplicable: number;
    complianceScore: number;
  };
  requirements: {
    id: string;
    name: string;
    status: 'pass' | 'fail' | 'warning' | 'na';
    findings: string[];
    recommendations: string[];
  }[];
}

// PCI DSS 4.0 Requirements
const PCI_DSS_4: ComplianceMapping = {
  framework: 'PCI DSS',
  version: '4.0',
  requirements: [
    { id: '1.1', name: 'Install and maintain network security controls', description: 'Firewall and network segmentation', category: 'Network Security' },
    { id: '1.2', name: 'Network security controls configured and maintained', description: 'Proper firewall rules', category: 'Network Security' },
    { id: '2.1', name: 'Secure configurations applied', description: 'Change default passwords', category: 'Secure Configuration' },
    { id: '2.2', name: 'System components configured securely', description: 'Hardening standards', category: 'Secure Configuration' },
    { id: '3.1', name: 'Protect stored account data', description: 'Data encryption at rest', category: 'Data Protection' },
    { id: '3.2', name: 'Sensitive authentication data not stored', description: 'No CVV/PIN storage', category: 'Data Protection' },
    { id: '4.1', name: 'Protect cardholder data with strong cryptography', description: 'TLS/encryption in transit', category: 'Encryption' },
    { id: '5.1', name: 'Malicious software prevented', description: 'Anti-malware deployed', category: 'Malware Protection' },
    { id: '6.1', name: 'Secure development processes', description: 'Secure SDLC', category: 'Secure Development' },
    { id: '6.2', name: 'Bespoke software developed securely', description: 'Code review and testing', category: 'Secure Development' },
    { id: '6.3', name: 'Security vulnerabilities identified and addressed', description: 'Vulnerability management', category: 'Vulnerability Management' },
    { id: '6.4', name: 'Public-facing web applications protected', description: 'WAF or code review', category: 'Web Security' },
    { id: '7.1', name: 'Access to system components restricted', description: 'Need-to-know access', category: 'Access Control' },
    { id: '8.1', name: 'User identification and authentication', description: 'Strong authentication', category: 'Authentication' },
    { id: '8.3', name: 'Strong authentication for users and admins', description: 'MFA required', category: 'Authentication' },
    { id: '9.1', name: 'Physical access to cardholder data restricted', description: 'Physical security', category: 'Physical Security' },
    { id: '10.1', name: 'Logging and monitoring implemented', description: 'Audit trails', category: 'Logging' },
    { id: '11.1', name: 'Security of systems and networks tested', description: 'Penetration testing', category: 'Testing' },
    { id: '11.3', name: 'External and internal vulnerabilities identified', description: 'Vulnerability scanning', category: 'Vulnerability Management' },
    { id: '12.1', name: 'Information security policy established', description: 'Security policies', category: 'Policy' },
  ]
};

// OWASP Top 10 2021
const OWASP_TOP_10: ComplianceMapping = {
  framework: 'OWASP Top 10',
  version: '2021',
  requirements: [
    { id: 'A01', name: 'Broken Access Control', description: 'Access control enforcement', category: 'Access Control' },
    { id: 'A02', name: 'Cryptographic Failures', description: 'Proper encryption usage', category: 'Cryptography' },
    { id: 'A03', name: 'Injection', description: 'SQL, NoSQL, OS, LDAP injection', category: 'Input Validation' },
    { id: 'A04', name: 'Insecure Design', description: 'Secure design patterns', category: 'Design' },
    { id: 'A05', name: 'Security Misconfiguration', description: 'Secure configurations', category: 'Configuration' },
    { id: 'A06', name: 'Vulnerable and Outdated Components', description: 'Component management', category: 'Dependencies' },
    { id: 'A07', name: 'Identification and Authentication Failures', description: 'Auth mechanisms', category: 'Authentication' },
    { id: 'A08', name: 'Software and Data Integrity Failures', description: 'CI/CD security', category: 'Integrity' },
    { id: 'A09', name: 'Security Logging and Monitoring Failures', description: 'Logging and detection', category: 'Logging' },
    { id: 'A10', name: 'Server-Side Request Forgery (SSRF)', description: 'SSRF prevention', category: 'Input Validation' },
  ]
};

// CIS Controls v8
const CIS_CONTROLS: ComplianceMapping = {
  framework: 'CIS Controls',
  version: '8.0',
  requirements: [
    { id: 'CIS-1', name: 'Inventory and Control of Enterprise Assets', description: 'Asset management', category: 'Asset Management' },
    { id: 'CIS-2', name: 'Inventory and Control of Software Assets', description: 'Software inventory', category: 'Asset Management' },
    { id: 'CIS-3', name: 'Data Protection', description: 'Data classification and protection', category: 'Data Protection' },
    { id: 'CIS-4', name: 'Secure Configuration of Enterprise Assets', description: 'Hardening', category: 'Configuration' },
    { id: 'CIS-5', name: 'Account Management', description: 'User account lifecycle', category: 'Access Control' },
    { id: 'CIS-6', name: 'Access Control Management', description: 'Access permissions', category: 'Access Control' },
    { id: 'CIS-7', name: 'Continuous Vulnerability Management', description: 'Vuln scanning', category: 'Vulnerability Management' },
    { id: 'CIS-8', name: 'Audit Log Management', description: 'Logging', category: 'Logging' },
    { id: 'CIS-9', name: 'Email and Web Browser Protections', description: 'Email/browser security', category: 'Endpoint' },
    { id: 'CIS-10', name: 'Malware Defenses', description: 'Anti-malware', category: 'Malware' },
    { id: 'CIS-11', name: 'Data Recovery', description: 'Backup and recovery', category: 'Recovery' },
    { id: 'CIS-12', name: 'Network Infrastructure Management', description: 'Network security', category: 'Network' },
    { id: 'CIS-13', name: 'Network Monitoring and Defense', description: 'Network monitoring', category: 'Monitoring' },
    { id: 'CIS-14', name: 'Security Awareness and Skills Training', description: 'Training', category: 'Training' },
    { id: 'CIS-15', name: 'Service Provider Management', description: 'Third-party risk', category: 'Third Party' },
    { id: 'CIS-16', name: 'Application Software Security', description: 'AppSec', category: 'Application' },
    { id: 'CIS-17', name: 'Incident Response Management', description: 'IR procedures', category: 'Incident Response' },
    { id: 'CIS-18', name: 'Penetration Testing', description: 'Pen testing', category: 'Testing' },
  ]
};

// Vulnerability to Compliance Mapping Rules
const VULN_COMPLIANCE_RULES: {
  pattern: RegExp;
  frameworks: { framework: string; requirements: string[] }[];
}[] = [
  // SQL Injection
  {
    pattern: /sql.?injection|sqli|sql\s+error/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A03'] },
      { framework: 'PCI DSS', requirements: ['6.2', '6.4'] },
      { framework: 'CIS Controls', requirements: ['CIS-16'] }
    ]
  },
  // XSS
  {
    pattern: /cross.?site.?script|xss|script.?injection/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A03'] },
      { framework: 'PCI DSS', requirements: ['6.2', '6.4'] },
      { framework: 'CIS Controls', requirements: ['CIS-16'] }
    ]
  },
  // Authentication Issues
  {
    pattern: /authentication|login|password|credential|brute.?force|weak.?password/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A07'] },
      { framework: 'PCI DSS', requirements: ['8.1', '8.3'] },
      { framework: 'CIS Controls', requirements: ['CIS-5', 'CIS-6'] }
    ]
  },
  // Encryption/TLS Issues
  {
    pattern: /ssl|tls|certificate|encryption|crypto|cipher|https/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A02'] },
      { framework: 'PCI DSS', requirements: ['4.1', '3.1'] },
      { framework: 'CIS Controls', requirements: ['CIS-3'] }
    ]
  },
  // Access Control
  {
    pattern: /access.?control|authorization|privilege|permission|idor|insecure.?direct/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A01'] },
      { framework: 'PCI DSS', requirements: ['7.1'] },
      { framework: 'CIS Controls', requirements: ['CIS-6'] }
    ]
  },
  // Misconfiguration
  {
    pattern: /misconfigur|default|exposed|directory.?listing|information.?disclosure/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A05'] },
      { framework: 'PCI DSS', requirements: ['2.1', '2.2'] },
      { framework: 'CIS Controls', requirements: ['CIS-4'] }
    ]
  },
  // Outdated Components
  {
    pattern: /outdated|vulnerable.?version|cve-|end.?of.?life|eol|deprecated/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A06'] },
      { framework: 'PCI DSS', requirements: ['6.3', '11.3'] },
      { framework: 'CIS Controls', requirements: ['CIS-7'] }
    ]
  },
  // SSRF
  {
    pattern: /ssrf|server.?side.?request/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A10'] },
      { framework: 'PCI DSS', requirements: ['6.2'] },
      { framework: 'CIS Controls', requirements: ['CIS-16'] }
    ]
  },
  // Open Ports/Services
  {
    pattern: /open.?port|exposed.?service|unnecessary.?service/i,
    frameworks: [
      { framework: 'PCI DSS', requirements: ['1.1', '1.2'] },
      { framework: 'CIS Controls', requirements: ['CIS-4', 'CIS-12'] }
    ]
  },
  // Logging Issues
  {
    pattern: /logging|audit|monitor/i,
    frameworks: [
      { framework: 'OWASP Top 10', requirements: ['A09'] },
      { framework: 'PCI DSS', requirements: ['10.1'] },
      { framework: 'CIS Controls', requirements: ['CIS-8'] }
    ]
  }
];

/**
 * Map a vulnerability to compliance frameworks
 */
export function mapVulnerabilityToCompliance(
  vuln: NormalizedVulnerability
): VulnerabilityComplianceResult {
  const mappings: VulnerabilityComplianceResult['mappings'] = [];
  const searchText = `${vuln.title} ${vuln.description} ${vuln.cve?.join(' ') || ''}`;
  
  // Check each rule
  for (const rule of VULN_COMPLIANCE_RULES) {
    if (rule.pattern.test(searchText)) {
      for (const fw of rule.frameworks) {
        const existing = mappings.find(m => m.framework === fw.framework);
        if (existing) {
          existing.requirements.push(...fw.requirements.filter(r => !existing.requirements.includes(r)));
        } else {
          mappings.push({
            framework: fw.framework,
            requirements: [...fw.requirements],
            severity: vuln.severity.label === 'critical' || vuln.severity.label === 'high' ? 'fail' : 'warning'
          });
        }
      }
    }
  }
  
  return {
    vulnId: vuln.id,
    vulnTitle: vuln.title,
    mappings
  };
}

/**
 * Generate compliance report for a set of vulnerabilities
 */
export function generateComplianceReport(
  vulnerabilities: NormalizedVulnerability[],
  framework: 'PCI DSS' | 'OWASP Top 10' | 'CIS Controls',
  scanId?: string
): ComplianceReport {
  const frameworkDef = framework === 'PCI DSS' ? PCI_DSS_4 :
                       framework === 'OWASP Top 10' ? OWASP_TOP_10 : CIS_CONTROLS;
  
  // Map all vulnerabilities
  const vulnMappings = vulnerabilities.map(v => mapVulnerabilityToCompliance(v));
  
  // Build requirement status
  const requirementStatus: Map<string, { status: 'pass' | 'fail' | 'warning' | 'na'; findings: string[]; }> = new Map();
  
  // Initialize all requirements as passed
  for (const req of frameworkDef.requirements) {
    requirementStatus.set(req.id, { status: 'pass', findings: [] });
  }
  
  // Update based on vulnerabilities
  for (const vulnMap of vulnMappings) {
    const fwMapping = vulnMap.mappings.find(m => m.framework === framework);
    if (fwMapping) {
      for (const reqId of fwMapping.requirements) {
        const current = requirementStatus.get(reqId);
        if (current) {
          current.findings.push(vulnMap.vulnTitle);
          if (fwMapping.severity === 'fail') {
            current.status = 'fail';
          } else if (current.status !== 'fail') {
            current.status = 'warning';
          }
        }
      }
    }
  }
  
  // Calculate summary
  let passed = 0, failed = 0, warnings = 0;
  for (const [, status] of requirementStatus) {
    if (status.status === 'pass') passed++;
    else if (status.status === 'fail') failed++;
    else if (status.status === 'warning') warnings++;
  }
  
  const complianceScore = Math.round((passed / frameworkDef.requirements.length) * 100);
  
  // Build report
  const requirements = frameworkDef.requirements.map(req => {
    const status = requirementStatus.get(req.id)!;
    return {
      id: req.id,
      name: req.name,
      status: status.status,
      findings: status.findings,
      recommendations: status.status !== 'pass' ? getRecommendations(req.id, framework) : []
    };
  });
  
  return {
    framework,
    version: frameworkDef.version,
    scanId,
    generatedAt: new Date().toISOString(),
    summary: {
      totalRequirements: frameworkDef.requirements.length,
      passed,
      failed,
      warnings,
      notApplicable: 0,
      complianceScore
    },
    requirements
  };
}

/**
 * Get recommendations for a failed requirement
 */
function getRecommendations(reqId: string, framework: string): string[] {
  const recommendations: Record<string, string[]> = {
    // OWASP
    'A01': ['Implement proper access control checks', 'Use deny-by-default principle', 'Log access control failures'],
    'A02': ['Use strong encryption algorithms (AES-256)', 'Implement TLS 1.2+', 'Properly manage encryption keys'],
    'A03': ['Use parameterized queries', 'Implement input validation', 'Use ORM frameworks'],
    'A04': ['Implement threat modeling', 'Use secure design patterns', 'Conduct security architecture reviews'],
    'A05': ['Remove default credentials', 'Disable unnecessary features', 'Implement security hardening'],
    'A06': ['Update vulnerable components', 'Remove unused dependencies', 'Monitor for new vulnerabilities'],
    'A07': ['Implement MFA', 'Use secure session management', 'Enforce strong password policies'],
    'A08': ['Verify software integrity', 'Use signed updates', 'Implement CI/CD security'],
    'A09': ['Implement comprehensive logging', 'Set up security monitoring', 'Create incident response procedures'],
    'A10': ['Validate and sanitize URLs', 'Use allowlists for external requests', 'Segment network access'],
    // PCI DSS
    '6.3': ['Establish vulnerability management program', 'Scan quarterly at minimum', 'Remediate critical vulns within 30 days'],
    '8.3': ['Implement multi-factor authentication', 'Use strong passwords', 'Implement account lockout'],
    // CIS
    'CIS-7': ['Perform regular vulnerability scans', 'Prioritize remediation by risk', 'Track remediation metrics'],
  };
  
  return recommendations[reqId] || ['Review and remediate identified vulnerabilities', 'Implement security controls'];
}

/**
 * Get all available compliance frameworks
 */
export function getAvailableFrameworks(): { id: string; name: string; version: string; requirementCount: number }[] {
  return [
    { id: 'pci-dss', name: 'PCI DSS', version: '4.0', requirementCount: PCI_DSS_4.requirements.length },
    { id: 'owasp-top-10', name: 'OWASP Top 10', version: '2021', requirementCount: OWASP_TOP_10.requirements.length },
    { id: 'cis-controls', name: 'CIS Controls', version: '8.0', requirementCount: CIS_CONTROLS.requirements.length },
  ];
}

export default {
  mapVulnerabilityToCompliance,
  generateComplianceReport,
  getAvailableFrameworks
};
