/**
 * Subfinder Parser - Parse Subfinder subdomain enumeration output
 */

import { BaseParser } from './base-parser';
import { NormalizedVulnerability, DiscoveredHost, DiscoveredService } from '../types';

export class SubfinderParser extends BaseParser {
  constructor() {
    super('subfinder', 'recon');
  }

  parseVulnerabilities(): NormalizedVulnerability[] {
    // Subfinder doesn't find vulnerabilities, only subdomains
    return [];
  }

  parseHosts(rawOutput: any): DiscoveredHost[] {
    const hosts: DiscoveredHost[] = [];
    const subdomains = this.extractSubdomains(rawOutput);

    for (const subdomain of subdomains) {
      hosts.push({
        id: this.generateId(),
        ip: subdomain,
        hostname: subdomain,
        state: 'unknown',
        discoveredBy: ['subfinder'],
        firstSeen: this.now(),
        lastSeen: this.now(),
        openPorts: [],
        services: [],
        vulnerabilityCount: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },
        riskScore: 0
      });
    }

    return hosts;
  }

  parseServices(): DiscoveredService[] {
    return [];
  }

  private extractSubdomains(rawOutput: any): string[] {
    if (Array.isArray(rawOutput)) {
      return rawOutput.filter(s => typeof s === 'string');
    }
    if (rawOutput.subdomains) return rawOutput.subdomains;
    if (rawOutput.results) return rawOutput.results;
    if (rawOutput.hosts) return rawOutput.hosts;
    if (typeof rawOutput === 'string') {
      return rawOutput.split('\n').filter(s => s.trim());
    }
    return [];
  }
}
