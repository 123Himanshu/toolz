/**
 * Gemini AI Provider
 * Uses Google Gemini 2.0 Flash-Lite (FREE and FAST)
 */

interface AIResponse {
  content: string;
  provider: 'gemini';
}

/**
 * Get AI completion from Gemini
 */
export async function getAICompletion(
  systemPrompt: string,
  userPrompt: string,
  options: {
    temperature?: number;
    maxTokens?: number;
  } = {}
): Promise<AIResponse> {
  const { temperature = 0.7, maxTokens = 2000 } = options;

  const geminiKey = process.env.GEMINI_API_KEY;
  if (!geminiKey) {
    throw new Error('GEMINI_API_KEY not configured');
  }

  try {
    const content = await callGemini(systemPrompt, userPrompt, geminiKey, temperature, maxTokens);
    return { content, provider: 'gemini' };
  } catch (error: any) {
    // Only log non-rate-limit errors
    if (!error.message?.includes('rate limit')) {
      console.error('Gemini AI error:', error);
    }
    throw error;
  }
}

/**
 * Call Gemini API (FREE and FAST!)
 */
async function callGemini(
  systemPrompt: string,
  userPrompt: string,
  apiKey: string,
  temperature: number,
  maxTokens: number
): Promise<string> {
  // Use latest stable Gemini model
  const response = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `${systemPrompt}\n\n${userPrompt}`
          }]
        }],
        generationConfig: {
          temperature,
          maxOutputTokens: maxTokens,
        }
      }),
    }
  );

  if (!response.ok) {
    const error = await response.text();
    // Check if it's a rate limit error
    if (response.status === 429) {
      throw new Error('Gemini API rate limit exceeded. Using local analysis.');
    }
    throw new Error(`Gemini API error: ${response.statusText}`);
  }

  const data = await response.json();
  
  // Check for error in response
  if (data.error) {
    throw new Error(`Gemini API error: ${data.error.message || JSON.stringify(data.error)}`);
  }
  
  // Check if response was cut off due to token limit
  const candidate = data.candidates?.[0];
  if (candidate?.finishReason === 'MAX_TOKENS') {
    throw new Error('Gemini response truncated (max tokens reached). Increase maxOutputTokens.');
  }
  
  // Extract text from response
  const text = candidate?.content?.parts?.[0]?.text;
  if (text) {
    return text;
  }
  
  // If no text, throw error with details
  throw new Error(`No text in Gemini response. Finish reason: ${candidate?.finishReason || 'unknown'}`);
}
