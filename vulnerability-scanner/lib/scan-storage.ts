// Simple file-based storage for scans (development)
import fs from 'fs';
import path from 'path';

const STORAGE_DIR = path.join(process.cwd(), '.scan-data');
const SCANS_FILE = path.join(STORAGE_DIR, 'scans.json');

// Ensure storage directory exists
if (!fs.existsSync(STORAGE_DIR)) {
  fs.mkdirSync(STORAGE_DIR, { recursive: true });
}

interface Scan {
  id: string;
  target: string;
  scanType: string;
  tools: any;
  config: any;
  status: string;
  progress: Record<string, string>;
  results: Record<string, any>;
  logs: Array<{ timestamp: string; tool: string; level: string; message: string }>;
  startedAt: string;
  completedAt: string | null;
  summary?: any;
  error?: string;
}

class ScanStorage {
  private scans: Map<string, Scan>;

  constructor() {
    this.scans = new Map();
    this.load();
  }

  private load() {
    try {
      if (fs.existsSync(SCANS_FILE)) {
        const data = fs.readFileSync(SCANS_FILE, 'utf-8');
        const scansArray = JSON.parse(data);
        this.scans = new Map(scansArray.map((scan: Scan) => [scan.id, scan]));
        console.log(`Loaded ${this.scans.size} scans from storage`);
      }
    } catch (error) {
      console.error('Error loading scans:', error);
      this.scans = new Map();
    }
  }

  private save() {
    try {
      const scansArray = Array.from(this.scans.values());
      fs.writeFileSync(SCANS_FILE, JSON.stringify(scansArray, null, 2));
    } catch (error) {
      console.error('Error saving scans:', error);
    }
  }

  set(scanId: string, scan: Scan) {
    this.scans.set(scanId, scan);
    this.save();
  }

  get(scanId: string): Scan | undefined {
    return this.scans.get(scanId);
  }

  getAll(): Scan[] {
    return Array.from(this.scans.values());
  }

  has(scanId: string): boolean {
    return this.scans.has(scanId);
  }

  delete(scanId: string) {
    this.scans.delete(scanId);
    this.save();
  }

  clear() {
    this.scans.clear();
    this.save();
  }

  size(): number {
    return this.scans.size;
  }

  keys(): string[] {
    return Array.from(this.scans.keys());
  }

  addLog(scanId: string, tool: string, level: string, message: string) {
    const scan = this.scans.get(scanId);
    if (scan) {
      if (!scan.logs) {
        scan.logs = [];
      }
      scan.logs.push({
        timestamp: new Date().toISOString(),
        tool,
        level,
        message
      });
      this.save();
    }
  }
}

// Singleton instance
let storage: ScanStorage | null = null;

export function getStorage(): ScanStorage {
  if (!storage) {
    storage = new ScanStorage();
  }
  return storage;
}
