/**
 * Phase 2 API: Attack Paths
 * GET /api/phase2/attack-paths
 * 
 * Get generated attack paths for a scan
 */

import { NextRequest, NextResponse } from 'next/server';
import { getPhase2Storage } from '@/lib/phase2';

export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const storage = getPhase2Storage();
    
    const scanId = searchParams.get('scanId');
    
    let attackPaths;
    if (scanId) {
      attackPaths = storage.getAttackPathsByScan(scanId);
    } else {
      // Return all attack paths if no scanId specified
      attackPaths = storage.getAllAttackPaths();
    }

    // Sort by risk
    attackPaths.sort((a, b) => b.overallRisk - a.overallRisk);

    return NextResponse.json({
      success: true,
      scanId,
      total: attackPaths.length,
      attackPaths: attackPaths.map(path => ({
        id: path.id,
        name: path.name,
        description: path.description,
        overallRisk: path.overallRisk,
        exploitability: path.exploitability,
        impact: path.impact,
        steps: path.nodes.length,
        entryPoints: path.entryPoints,
        targets: path.targets,
        mitigations: path.mitigations,
        prioritizedFixes: path.prioritizedFixes,
        graph: {
          nodes: path.nodes,
          edges: path.edges
        }
      }))
    });

  } catch (error) {
    console.error('Attack paths query error:', error);
    return NextResponse.json(
      { error: 'Query failed', details: String(error) },
      { status: 500 }
    );
  }
}
