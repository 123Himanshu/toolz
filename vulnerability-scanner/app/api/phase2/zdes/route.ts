/**
 * Zero-Day Exposure Score (ZDES) API
 */

import { NextRequest, NextResponse } from 'next/server';
import { calculateZDES, calculateAllZDES } from '@/lib/phase2/zero-day-score';
import { getPhase2Storage } from '@/lib/phase2/storage';

export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const hostIp = searchParams.get('host');
    const scanId = searchParams.get('scanId');

    // Get data
    const storage = getPhase2Storage();
    const vulns = storage.queryVulnerabilities({ scanId: scanId || undefined }).data;
    const hosts = storage.getAllHosts();
    const services = storage.getAllServices();

    if (hostIp) {
      // Calculate ZDES for single host
      const host = hosts.find(h => h.ip === hostIp);
      if (!host) {
        return NextResponse.json({ success: false, error: 'Host not found' }, { status: 404 });
      }

      const result = calculateZDES(host, vulns, services);
      return NextResponse.json({
        success: true,
        host: hostIp,
        zdes: result
      });
    }

    // Calculate ZDES for all hosts
    const allResults = calculateAllZDES(hosts, vulns, services);
    
    // Convert to array and sort by score
    const results = Array.from(allResults.entries())
      .map(([ip, result]) => ({
        host: ip,
        hostname: hosts.find(h => h.ip === ip)?.hostname,
        ...result
      }))
      .sort((a, b) => b.score - a.score);

    // Summary statistics
    const summary = {
      totalHosts: results.length,
      critical: results.filter(r => r.label === 'critical').length,
      high: results.filter(r => r.label === 'high').length,
      medium: results.filter(r => r.label === 'medium').length,
      low: results.filter(r => r.label === 'low').length,
      averageScore: results.length > 0 
        ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length)
        : 0,
      topIndicators: getTopIndicators(results)
    };

    return NextResponse.json({
      success: true,
      summary,
      hosts: results.slice(0, 20)
    });
  } catch (error: any) {
    console.error('ZDES API error:', error);
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    );
  }
}

function getTopIndicators(results: any[]): { type: string; count: number }[] {
  const indicatorCounts = new Map<string, number>();

  for (const result of results) {
    for (const indicator of result.indicators || []) {
      const key = indicator.type;
      indicatorCounts.set(key, (indicatorCounts.get(key) || 0) + 1);
    }
  }

  return Array.from(indicatorCounts.entries())
    .map(([type, count]) => ({ type, count }))
    .sort((a, b) => b.count - a.count)
    .slice(0, 5);
}
