/**
 * Threat Intelligence API - Enrich vulnerabilities with threat intel
 */

import { NextRequest, NextResponse } from 'next/server';
import { enrichWithThreatIntel, batchEnrichVulnerabilities } from '@/lib/phase2/threat-intel';
import { getPhase2Storage } from '@/lib/phase2/storage';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { cveId, cve } = body;
    const targetCve = cveId || cve;

    if (!targetCve) {
      return NextResponse.json({ success: false, error: 'CVE ID required' }, { status: 400 });
    }

    const mockVuln = { cve: [targetCve] } as any;
    const intel = await enrichWithThreatIntel(mockVuln);

    return NextResponse.json({
      success: true,
      cve: targetCve,
      data: intel,
      threatIntel: intel
    });
  } catch (error) {
    console.error('Threat intel POST error:', error);
    return NextResponse.json({ success: false, error: 'Failed to enrich CVE' }, { status: 500 });
  }
}

export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const cve = searchParams.get('cve');
    const scanId = searchParams.get('scanId');

    if (cve) {
      // Enrich single CVE
      const mockVuln = { cve: [cve] } as any;
      const intel = await enrichWithThreatIntel(mockVuln);
      
      return NextResponse.json({
        success: true,
        cve,
        threatIntel: intel
      });
    }

    if (scanId) {
      // Enrich all vulnerabilities in a scan
      const storage = getPhase2Storage();
      const vulns = storage.getVulnerabilitiesByScan(scanId);
      const intelMap = await batchEnrichVulnerabilities(vulns);

      return NextResponse.json({
        success: true,
        scanId,
        enrichedCount: intelMap.size,
        threatIntel: Object.fromEntries(intelMap)
      });
    }

    // Return available threat intel sources and stats
    return NextResponse.json({
      success: true,
      sources: [
        { name: 'NVD', description: 'National Vulnerability Database', status: 'active' },
        { name: 'EPSS', description: 'Exploit Prediction Scoring System', status: 'active' },
        { name: 'CISA KEV', description: 'Known Exploited Vulnerabilities', status: 'active' },
        { name: 'ExploitDB', description: 'Exploit Database', status: 'active' }
      ],
      usage: {
        enrichSingleCVE: '/api/phase2/threat-intel?cve=CVE-2021-44228',
        enrichScan: '/api/phase2/threat-intel?scanId=<scan-id>'
      },
      enrichments: []
    });
  } catch (error) {
    console.error('Threat intel error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to fetch threat intelligence' },
      { status: 500 }
    );
  }
}
