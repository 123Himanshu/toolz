/**
 * Remediation API - Track and manage vulnerability remediation
 */

import { NextRequest, NextResponse } from 'next/server';
import {
  updateRemediationStatus,
  getRemediationStatus,
  getRemediationStats,
  generateRemediationPlan,
  RemediationStatus
} from '@/lib/phase2/remediation';
import { getPhase2Storage } from '@/lib/phase2/storage';

// GET - Get remediation status or stats
export async function GET(request: NextRequest) {
  try {
    const searchParams = request.nextUrl.searchParams;
    const vulnerabilityId = searchParams.get('vulnerabilityId');
    const action = searchParams.get('action');

    if (action === 'stats') {
      return NextResponse.json({
        success: true,
        stats: getRemediationStats()
      });
    }

    if (action === 'plan') {
      const scanId = searchParams.get('scanId');
      const storage = getPhase2Storage();
      const vulns = scanId 
        ? storage.getVulnerabilitiesByScan(scanId)
        : storage.queryVulnerabilities({}).data;
      
      return NextResponse.json({
        success: true,
        plan: generateRemediationPlan(vulns)
      });
    }

    if (vulnerabilityId) {
      const status = getRemediationStatus(vulnerabilityId);
      return NextResponse.json({
        success: true,
        status: status || { status: 'open' }
      });
    }

    return NextResponse.json({
      success: true,
      stats: getRemediationStats()
    });
  } catch (error) {
    console.error('Remediation GET error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to get remediation data' },
      { status: 500 }
    );
  }
}


// POST - Update remediation status
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { vulnerabilityId, status, assignee, notes, fixedBy, acceptedReason } = body;

    if (!vulnerabilityId || !status) {
      return NextResponse.json(
        { success: false, error: 'vulnerabilityId and status are required' },
        { status: 400 }
      );
    }

    const validStatuses: RemediationStatus[] = ['open', 'in_progress', 'fixed', 'accepted', 'false_positive'];
    if (!validStatuses.includes(status)) {
      return NextResponse.json(
        { success: false, error: `Invalid status. Must be one of: ${validStatuses.join(', ')}` },
        { status: 400 }
      );
    }

    const record = updateRemediationStatus(vulnerabilityId, status, {
      assignee,
      notes,
      fixedBy,
      acceptedReason
    });

    return NextResponse.json({
      success: true,
      record
    });
  } catch (error) {
    console.error('Remediation POST error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to update remediation status' },
      { status: 500 }
    );
  }
}
