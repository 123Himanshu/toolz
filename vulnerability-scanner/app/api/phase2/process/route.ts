/**
 * Phase 2 API: Process Scan Results
 * POST /api/phase2/process
 * 
 * Processes raw scan results through the Phase 2 pipeline:
 * - Normalization
 * - Deduplication
 * - Risk Scoring
 * - Correlation
 * - Attack Path Generation
 */

import { NextRequest, NextResponse } from 'next/server';
import { processScanResults } from '@/lib/phase2';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { scanId, target, results, tools } = body;

    if (!scanId || !target || !results) {
      return NextResponse.json(
        { error: 'Missing required fields: scanId, target, results' },
        { status: 400 }
      );
    }

    // Process through Phase 2 pipeline
    const processingResult = await processScanResults(
      scanId,
      target,
      results,
      tools || Object.keys(results)
    );

    return NextResponse.json({
      success: true,
      scanId,
      target,
      summary: {
        vulnerabilities: {
          total: processingResult.vulnerabilities.length,
          bySeverity: processingResult.riskScore.bySeverity
        },
        hosts: processingResult.hosts.length,
        services: processingResult.services.length,
        deduplication: processingResult.deduplication,
        riskScore: processingResult.riskScore,
        correlation: processingResult.correlation,
        attackPaths: processingResult.attackPaths.length
      },
      data: {
        vulnerabilities: processingResult.vulnerabilities,
        hosts: processingResult.hosts,
        services: processingResult.services,
        attackPaths: processingResult.attackPaths,
        session: processingResult.session
      }
    });

  } catch (error) {
    console.error('Phase 2 processing error:', error);
    return NextResponse.json(
      { error: 'Processing failed', details: String(error) },
      { status: 500 }
    );
  }
}
