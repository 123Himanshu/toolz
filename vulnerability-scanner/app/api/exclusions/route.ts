/**
 * Exclusions API
 * Manage exclusion lists for scans
 */

import { NextRequest, NextResponse } from 'next/server';
import {
  getAllExclusionLists,
  getExclusionList,
  createExclusionList,
  addExclusionEntry,
  removeExclusionEntry,
  toggleExclusionEntry,
  deleteExclusionList,
  shouldExclude,
  filterTargets
} from '@/lib/exclusions';

// GET - List exclusion lists or check target
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const id = searchParams.get('id');
    const checkTarget = searchParams.get('check');
    
    // Check if target should be excluded
    if (checkTarget) {
      const result = shouldExclude(checkTarget);
      return NextResponse.json({
        success: true,
        target: checkTarget,
        ...result
      });
    }
    
    // Get specific list
    if (id) {
      const list = getExclusionList(id);
      if (!list) {
        return NextResponse.json(
          { success: false, error: 'List not found' },
          { status: 404 }
        );
      }
      return NextResponse.json({ success: true, list });
    }
    
    // Get all lists
    const lists = getAllExclusionLists();
    return NextResponse.json({
      success: true,
      total: lists.length,
      lists
    });
  } catch (error) {
    console.error('Exclusions GET error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to fetch exclusions' },
      { status: 500 }
    );
  }
}

// POST - Create list or add entry
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { action, listId, name, description, entry, targets } = body;
    
    // Filter targets
    if (action === 'filter' && targets) {
      const result = filterTargets(targets);
      return NextResponse.json({
        success: true,
        ...result
      });
    }
    
    // Add entry to existing list
    if (action === 'addEntry' && listId && entry) {
      const newEntry = addExclusionEntry(listId, entry);
      if (!newEntry) {
        return NextResponse.json(
          { success: false, error: 'List not found' },
          { status: 404 }
        );
      }
      return NextResponse.json({
        success: true,
        message: 'Entry added',
        entry: newEntry
      });
    }
    
    // Create new list
    if (name) {
      const list = createExclusionList(name, description || '', body.entries || []);
      return NextResponse.json({
        success: true,
        message: 'List created',
        list
      });
    }
    
    return NextResponse.json(
      { success: false, error: 'Invalid request' },
      { status: 400 }
    );
  } catch (error) {
    console.error('Exclusions POST error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to process request' },
      { status: 500 }
    );
  }
}

// PUT - Toggle entry
export async function PUT(request: NextRequest) {
  try {
    const body = await request.json();
    const { listId, entryId } = body;
    
    if (!listId || !entryId) {
      return NextResponse.json(
        { success: false, error: 'listId and entryId required' },
        { status: 400 }
      );
    }
    
    const toggled = toggleExclusionEntry(listId, entryId);
    if (!toggled) {
      return NextResponse.json(
        { success: false, error: 'Entry not found' },
        { status: 404 }
      );
    }
    
    return NextResponse.json({
      success: true,
      message: 'Entry toggled'
    });
  } catch (error) {
    console.error('Exclusions PUT error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to toggle entry' },
      { status: 500 }
    );
  }
}

// DELETE - Remove entry or list
export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const listId = searchParams.get('listId');
    const entryId = searchParams.get('entryId');
    
    if (!listId) {
      return NextResponse.json(
        { success: false, error: 'listId required' },
        { status: 400 }
      );
    }
    
    // Delete entry
    if (entryId) {
      const removed = removeExclusionEntry(listId, entryId);
      if (!removed) {
        return NextResponse.json(
          { success: false, error: 'Entry not found' },
          { status: 404 }
        );
      }
      return NextResponse.json({
        success: true,
        message: 'Entry removed'
      });
    }
    
    // Delete list
    const deleted = deleteExclusionList(listId);
    if (!deleted) {
      return NextResponse.json(
        { success: false, error: 'Cannot delete default list or list not found' },
        { status: 400 }
      );
    }
    
    return NextResponse.json({
      success: true,
      message: 'List deleted'
    });
  } catch (error) {
    console.error('Exclusions DELETE error:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to delete' },
      { status: 500 }
    );
  }
}
