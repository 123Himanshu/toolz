import { NextRequest, NextResponse } from 'next/server';
import { getGrokRecommendation, getSmartToolRecommendation } from '@/lib/grok-ai';

export const dynamic = 'force-dynamic';

export async function POST(request: NextRequest) {
  try {
    const { target } = await request.json();

    if (!target) {
      return NextResponse.json(
        { error: 'Target is required' },
        { status: 400 }
      );
    }

    // Get SMART tool recommendation (no duplication!)
    const smartRecommendation = await getSmartToolRecommendation(target);

    // Get AI insight from Grok
    let aiInsight = smartRecommendation.aiInsight;
    try {
      aiInsight = await getGrokRecommendation(target);
    } catch (error) {
      console.log('Grok AI unavailable, using local smart analysis');
    }

    // Convert to UI format
    const recommendedTools = [
      ...smartRecommendation.tools.network.map(tool => ({
        toolId: tool,
        category: 'network',
        confidence: 0.9,
        reason: getToolReason(tool)
      })),
      ...smartRecommendation.tools.web.map(tool => ({
        toolId: tool,
        category: 'web',
        confidence: 0.9,
        reason: getToolReason(tool)
      })),
      ...smartRecommendation.tools.system.map(tool => ({
        toolId: tool,
        category: 'system',
        confidence: 0.9,
        reason: getToolReason(tool)
      }))
    ];

    return NextResponse.json({
      success: true,
      target,
      recommendation: aiInsight,
      recommendedTools,
      scanType: smartRecommendation.scanType,
      reasoning: smartRecommendation.reasoning,
      toolCount: recommendedTools.length,
      smartSelection: true,
      timestamp: new Date().toISOString()
    });
  } catch (error: any) {
    console.error('AI recommendation error:', error);
    return NextResponse.json(
      { 
        error: 'Failed to get AI recommendation',
        details: error.message 
      },
      { status: 500 }
    );
  }
}

function getToolReason(tool: string): string {
  const reasons: Record<string, string> = {
    'nmap': 'Core network scanner - service detection, OS fingerprinting, NSE scripts',
    'rustscan': 'Ultra-fast port discovery (3 sec for 65535 ports) - feeds to Nmap',
    'masscan': 'Internet-scale scanner for large IP ranges - 10M packets/sec',
    'naabu': 'Fast port scanner with clean JSON output - perfect for automation',
    'nuclei': 'Core CVE scanner - 5000+ templates, fuzzing, custom workflows',
    'wapiti': 'Web vulnerability scanner - XSS, SQLi, LFI, CRLF checks',
    'nikto': 'Legacy server scanner - 6800+ checks for old Apache/IIS/Nginx',
    'trivy': 'Container/IaC/filesystem scanner - SBOM generation, compliance',
    'openvas': 'Enterprise CVE scanner - 50,000+ tests, compliance checks',
    'nessus': 'Industry-leading scanner - 65,000+ plugins, compliance auditing (PCI, HIPAA)'
  };
  return reasons[tool] || 'Specialized security tool';
}
