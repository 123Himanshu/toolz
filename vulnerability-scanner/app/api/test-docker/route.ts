import { NextResponse } from 'next/server';
import { spawn } from 'child_process';

const isWindows = process.platform === 'win32';

function execAsync(command: string): Promise<{ stdout: string; stderr: string; code: number | null }> {
  return new Promise((resolve) => {
    const shell = isWindows ? 'powershell.exe' : '/bin/sh';
    const shellArgs = isWindows ? ['-NoProfile', '-Command', command] : ['-c', command];
    
    console.log('Shell:', shell);
    console.log('Args:', shellArgs);
    console.log('CWD:', process.cwd());
    console.log('PATH:', process.env.PATH?.substring(0, 100));
    
    const proc = spawn(shell, shellArgs, {
      windowsHide: true,
      stdio: ['pipe', 'pipe', 'pipe'],
      env: process.env,
    });
    
    proc.stdin?.end();
    
    let stdout = '';
    let stderr = '';
    
    proc.stdout?.on('data', (data) => {
      stdout += data.toString();
    });
    
    proc.stderr?.on('data', (data) => {
      stderr += data.toString();
    });
    
    proc.on('close', (code) => {
      resolve({ stdout, stderr, code });
    });
  });
}

export async function GET() {
  console.log('=== Testing Docker from Next.js API ===');
  
  // Test 1: Simple echo
  const test1 = await execAsync('echo "hello from powershell"');
  console.log('Test 1 (echo):', test1);
  
  // Test 2: Docker version
  const test2 = await execAsync('docker --version');
  console.log('Test 2 (docker version):', test2);
  
  // Test 3: Simple Docker run
  const test3 = await execAsync('docker run --rm -i security-scanner python3 -c "print(123)"');
  console.log('Test 3 (docker run):', test3);
  
  // Test 4: Full nmap command
  const test4 = await execAsync('docker run --rm -i security-scanner python3 -c "from nmap_wrapper import NmapWrapper; print(\'test\')"');
  console.log('Test 4 (nmap import):', test4);
  
  // Test 5: With explicit context
  const test5 = await execAsync('docker --context desktop-linux run --rm -i security-scanner python3 -c "print(456)"');
  console.log('Test 5 (explicit context):', test5);
  
  // Test 6: Without -i flag
  const test6 = await execAsync('docker run --rm security-scanner python3 -c "print(789)"');
  console.log('Test 6 (no -i flag):', test6);
  
  return NextResponse.json({
    platform: process.platform,
    test1,
    test2,
    test3,
    test4,
    test5,
    test6,
  });
}
