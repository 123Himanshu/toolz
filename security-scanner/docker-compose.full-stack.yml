################################################################################
# FULL STACK DOCKER COMPOSE
# Includes: Redis, Elasticsearch, OpenVAS
# Uses minimal/alpine images to save space
################################################################################

version: '3.8'

services:
  # ===========================================================================
  # REDIS - Job Queue, Caching, Sessions
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: vuln-scanner-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scanner-network

  # ===========================================================================
  # ELASTICSEARCH - Full-text Search (using OpenSearch for lighter footprint)
  # ===========================================================================
  elasticsearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: vuln-scanner-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - plugins.security.disabled=true
      - DISABLE_INSTALL_DEMO_CONFIG=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - elasticsearch_data:/usr/share/opensearch/data
    ports:
      - "9200:9200"
      - "9600:9600"
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - scanner-network

  # ===========================================================================
  # OPENSEARCH DASHBOARDS (Optional - for visualization)
  # ===========================================================================
  # opensearch-dashboards:
  #   image: opensearchproject/opensearch-dashboards:2.11.0
  #   container_name: vuln-scanner-dashboards
  #   restart: unless-stopped
  #   ports:
  #     - "5601:5601"
  #   environment:
  #     - OPENSEARCH_HOSTS=["http://elasticsearch:9200"]
  #     - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
  #   depends_on:
  #     - elasticsearch
  #   networks:
  #     - scanner-network

  # ===========================================================================
  # OPENVAS - Vulnerability Scanner
  # ===========================================================================
  openvas:
    image: greenbone/community-container:stable
    container_name: openvas-gvm
    restart: unless-stopped
    ports:
      - "9390:9390"   # GMP API
      - "9392:9392"   # GSA Web (internal)
      - "443:443"     # HTTPS Web UI
    volumes:
      - openvas_data:/var/lib/gvm
      - openvas_logs:/var/log/gvm
    environment:
      - GVM_ADMIN_PASSWORD=admin
      - COMMUNITY_EDITION=1
    healthcheck:
      test: ["CMD-SHELL", "gvm-cli --gmp-username admin --gmp-password admin socket --socketpath /run/gvmd/gvmd.sock --xml '<get_version/>' || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 300s
    networks:
      - scanner-network

networks:
  scanner-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
  elasticsearch_data:
    driver: local
  openvas_data:
    driver: local
  openvas_logs:
    driver: local
