"""
ExploitDB enrichment
"""
import requests
from typing import Dict, Any, List
from models.schemas import NormalizedVulnerability
from utils.logger import engine_logger

class ExploitDBEnricher:
    """Enrich vulnerabilities with ExploitDB data"""
    
    def __init__(self):
        self.logger = engine_logger
        self.exploits_cache = {}
        self._load_exploitdb_data()
    
    def _load_exploitdb_data(self):
        """Load ExploitDB CSV data (can be downloaded from exploit-db.com)"""
        # In production, download and parse files_exploits.csv
        # For now, use API approach
        self.logger.info("ExploitDB enricher initialized")
    
    def enrich(self, vulnerability: NormalizedVulnerability) -> NormalizedVulnerability:
        """Enrich vulnerability with ExploitDB data"""
        
        if not vulnerability.cve_id:
            return vulnerability
        
        try:
            exploits = self._search_exploits(vulnerability.cve_id)
            
            if exploits:
                vulnerability.exploit_available = True
                vulnerability.exploit_metadata['exploitdb'] = exploits
                self.logger.debug(f"Found {len(exploits)} exploits for {vulnerability.cve_id}")
        
        except Exception as e:
            self.logger.error(f"ExploitDB enrichment error: {e}")
        
        return vulnerability
    
    def _search_exploits(self, cve_id: str) -> List[Dict[str, Any]]:
        """Search for exploits by CVE ID"""
        
        # Check cache first
        if cve_id in self.exploits_cache:
            return self.exploits_cache[cve_id]
        
        exploits = []
        
        try:
            # Use exploit-db.com search API
            url = f"https://www.exploit-db.com/search?cve={cve_id}"
            
            # Alternative: Use GitHub API to search exploit-database repo
            # This is a simplified approach
            github_url = "https://api.github.com/search/code"
            params = {
                'q': f'{cve_id} repo:offensive-security/exploitdb',
                'per_page': 10
            }
            
            response = requests.get(github_url, params=params, timeout=10)
            
            if response.status_code == 200:
                data = response.json()
                items = data.get('items', [])
                
                for item in items:
                    exploits.append({
                        'name': item.get('name'),
                        'path': item.get('path'),
                        'url': item.get('html_url'),
                        'source': 'ExploitDB'
                    })
        
        except Exception as e:
            self.logger.debug(f"ExploitDB search failed: {e}")
        
        # Cache result
        self.exploits_cache[cve_id] = exploits
        
        return exploits
    
    def search_by_software(self, software: str, version: str = None) -> List[Dict[str, Any]]:
        """Search exploits by software name and version"""
        
        query = software
        if version:
            query += f" {version}"
        
        # Simplified search - in production, use proper ExploitDB API or CSV parsing
        return []
